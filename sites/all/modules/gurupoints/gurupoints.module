<?php

/**
 * Implementation of hook_perm().
 */
function gurupoints_perm() {
    return array('Add Points', 'list Points', 'Home List', 'Add Coins','List Coins');
}

/**
 * Implementation of hook_menu().
 */
function gurupoints_menu() {

    $search_result['admin/addpoints'] = array('title' => ' Add Points', 'page callback' => 'add_points', 'access arguments' => array('Add Points'), 'type' => MENU_SUGGESTED_ITEM, 'file' => 'gurupoints.pages.inc',);

    $search_result['admin/point/save'] = array('title' => ' Add Points', 'page callback' => 'save_points', 'access arguments' => array('Add Points'), 'type' => MENU_SUGGESTED_ITEM, 'file' => 'gurupoints.pages.inc',);

    $search_result['admin/userpoints'] = array('title' => 'User Points', 'page callback' => 'user_points', 'access arguments' => array('list Points'), 'type' => MENU_SUGGESTED_ITEM, 'file' => 'gurupoints.pages.inc',);
    $search_result['pundit/ajax'] = array('title' => 'Ajax Listing', 'page callback' => 'ajax_pundits', 'access arguments' => array('Home List'), 'type' => MENU_SUGGESTED_ITEM, 'file' => 'gurupoints.pages.inc',);
    $search_result['admin/addcoins'] = array('title' => ' Add Coins', 'page callback' => 'add_coins', 'access arguments' => array('Add Coins'), 'type' => MENU_SUGGESTED_ITEM, 'file' => 'gurupoints.pages.inc',);
    $search_result['admin/coin/save'] = array('title' => ' Add Coins', 'page callback' => 'save_coins', 'access arguments' => array('Add Coins'), 'type' => MENU_SUGGESTED_ITEM, 'file' => 'gurupoints.pages.inc',);
    $search_result['admin/user/coins'] = array('title' => 'User Coin List', 'page callback' => 'user_coins','access arguments' => array('List Coins'), 'type' => MENU_SUGGESTED_ITEM, 'file' => 'gurupoints.pages.inc',);

    return $search_result;
}

function increasepoints($ptype, $qid, $idm) {
    global $gSitePath, $user, $gDocPath, $base_root, $base_path;


    $queryuser = "SELECT * FROM user_profile where uid=$user->uid ";
    $query_result = db_query($queryuser);
    $userresult = db_fetch_object($query_result);

    if ($idm == '0') {
        $numpt = db_result(db_query("SELECT COUNT(*) from {tbl_user_points} where point_id='$ptype' and qid='$qid' and uid='$user->uid'"));
        $query_pt = "SELECT * FROM tbl_points where id='$ptype' ";
        $query_ptinfo = db_query($query_pt);
        $fetuserpts = db_fetch_object($query_ptinfo);

        if ($numpt == 0) {
            $insert_pts = "insert into tbl_user_points (uid,qid,point_id,points,vote_point_id) values($user->uid,$qid,$ptype,$fetuserpts->points,$idm)";
            $qus = db_query($insert_pts);
            $totpts = $userresult->points + $fetuserpts->points;
            $uppts = "update user_profile set points=$totpts where uid=$user->uid";
            $quspts = db_query($uppts);
        }
    } else {
        //echo $idm;


        $cntr = db_result(db_query("SELECT COUNT(*) from {tbl_user_points} where vote_point_id='$idm' and qid='$qid' and uid='$user->uid'"));

        $query_ptm = "select * from tbl_vote_gurupoints where id='" . $idm . "'";
        $query_ptinfo = db_query($query_ptm);
        $fetuserpts = db_fetch_object($query_ptinfo);


        if ($cntr == 0) {
            $insert_pts = "insert into tbl_user_points (uid,qid,point_id,points,vote_point_id) values($user->uid,$qid,$ptype,$fetuserpts->points,$idm)";
            $qus = db_query($insert_pts);
            $totpts = $userresult->points + $fetuserpts->points;
            $uppts = "update user_profile set points=$totpts where uid=$user->uid";
            $quspts = db_query($uppts);
        }
    }
}

/*
  function ajax_pundits(){
  global $gSitePath,$user,$gDocPath,$base_root,$base_path;
  $output =array();
  extract($_REQUEST);
  $first=(!empty($first))?(($first==1)?'0':$first):'0';
  $last=(!empty($last))?$last-1:'4';
  $query = "select * from {gurulist} limit $first,4";
  $list = ExecuteQuery($query, "select");
  $total=db_result(db_query('select count(*) from {gurulist}'));
  $page_incr = 0;
  $pager = 1;
  //$output.='<total>'.$total.'</total>';
  $i = 0;
  foreach ($list as $quest) {

  $udetails=load_user($quest['uid']);
  $bubble = load_bubble($udetails->uid);

  //  $output.= '<li><a  href="'.$gSitePath.'/profile/'.$udetails->name.'">'.UserPicture($quest['uid']).'</a></li>';
  $output[$i]['total']=$total;
  $output[$i]['title']=$udetails->real_name;
  $output[$i]['url']=$gSitePath.'/profile/'.$udetails->name;
  $output[$i]['image']=UserPicture($quest['uid']);
  // $output[$i]['rel']=$bubble;
  $i++;
  }


  echo json_encode($output);
  }
 */

function create_guru_view() {
global $gSitePath,$user,$gDocPath,$base_root,$base_path;
    db_query("DROP VIEW IF EXISTS {gurulist}");
    $cond='';
    $wher='';
    // $view = "CREATE VIEW {gurulist} (SELECT (select ifnull(sum(points),0) as qpt from {tbl_user_points} where uid=a.uid group by uid) as tpoints,a.uid, a.name,u.real_name, a.mail, SUM(b.points) AS point FROM users as a join {user_profile} as u on u.uid=a.uid  LEFT OUTER JOIN tbl_user_points as b ON a.uid = b.uid GROUP BY uid) ";
    if(!empty($_REQUEST['cid'])){
        extract($_REQUEST);


        $cond=" join {follower} as f on f.uid=u.uid";
        if(!empty ($scid))
         $wher=" AND (f.cat_id='".$cid."' OR f.cat_id='".$scid."') group by u.uid";
        else
          $wher=" AND f.cat_id='".$cid."' group by u.uid";

    
    }
 
    $view = "CREATE VIEW gurulist as (SELECT (select ifnull(sum(points),0) as qpt from {tbl_user_points} where uid=u.uid group by uid) as tpoints,a.uid as uid, a.name,u.real_name FROM {users} as a join {user_profile} as u on u.uid=a.uid $cond where a.status='1' $wher)";
    db_query($view);
}

function ajax_pundits() {
    global $gSitePath, $user, $gDocPath, $base_root, $base_path;
    $cond='';
    extract($_REQUEST);
    $first = (!empty($first)) ? (($first == 1) ? '0' : $first) : '0';
    $last = (!empty($last)) ? $last - 1 : '4';
    $catid=(!empty($scid))?$scid:$cid;
    if(!empty($catid))
        $cond=" AND cat_id='$catid' ";

 //   print_r($_REQUEST);
  //  create_guru_view();
  if(!empty($cond))
     $user_pt = "select * from {pundit_section} where score !='NULL' $cond  order by score desc limit $first,4  ";
   else
        $user_pt = "select * from {pundit_section} where score !='NULL'  group by uid order by score desc limit $first,4  ";
  $list = ExecuteQuery($user_pt, "select");

   
    
    if(count($list)>0){

 $output.= '<ul>';
    foreach ($list as $quest) {

        $udetails = load_user($quest['uid']);
        $bubble = load_bubble($udetails->uid);

        $output.= '<li><a rel=\'' . $bubble . '\'  href="' . $gSitePath . '/profile/' . $udetails->name . '">' . UserPicture($quest['uid']) . '</a></li>';

    }
     $output.= '</ul>';
    }else{
         $output.= '<center><small>No Pundit(s) Found </small></center>';
    }
   

    echo $output;
}

function insertpoints($action = '', $nodeid = '') {
    global $gSitePath, $user, $gDocPath, $base_root, $base_path;

    if (!empty($nodeid) && !empty($action)) {
        $set = $action . "='1'";
        //points
        $query_pt = "SELECT * FROM tbl_points where id='3' ";
        $query_ptinfo = db_query($query_pt);
        $fetuserpts = db_fetch_object($query_ptinfo);
        $queryuser = "SELECT count(*) FROM {tbl_user_points}  where uid='$user->uid' AND $set AND nodeid='$nodeid' ";
        $rcnt = db_result(db_query($queryuser));

        if ($rcnt == 0) {

            db_query("insert into {tbl_user_points} set point_id='$fetuserpts->id',points='$fetuserpts->points',uid='$user->uid',$set,nodeid='$nodeid'");
        }
    }
}

function guru_points($switch = '', $uid = '') {

    global $gSitePath, $user, $gDocPath, $base_root, $base_path;
    switch ($switch) {
        case 'user':

            $view = "SELECT (select ifnull(sum(points),0) as qpt from {tbl_user_points} where uid=u.uid group by uid) as tpoints FROM {users} as a join {user_profile} as u on u.uid='$uid' where a.status='1'";
            $outputppt = db_result(db_query($view));

            break;
        default:


            create_guru_view();

            $user_pt = "select * from {gurulist} where tpoints !='NULL' order by tpoints desc ";
            $point_list = ExecuteQuery($user_pt, "select");

            $outputppt = '<table width="60%" border="0" cellspacing="0" cellpadding="0">
   
   
  <tr>
    <td><h2>User</h2></td>
   <td><h2>Total Points</h2></td>
  </tr>';
            for ($p = 0; $p < count($point_list); $p++) {

                $puid = $point_list[$p]['uid'];

                /*
                  $qptstd="select (select SUM(points) AS qpt   FROM tbl_user_points where  uid=u.uid and point_id='2' group by uid) as a,
                  (select SUM(points) AS qpt   FROM tbl_user_points where  uid=u.uid and point_id='1' group by uid) as b,
                  (select SUM(points) AS qpt   FROM tbl_user_points where uid=u.uid and point_id='3' group by uid) as c,
                  (select SUM(points) AS qpt   FROM tbl_user_points where  uid=u.uid and point_id='4' group by uid) as d,
                  (select SUM(points) AS qpt   FROM tbl_user_points where  uid=u.uid and point_id='5' group by uid) as e,
                  (select SUM(points) AS qpt   FROM tbl_user_points where  uid=u.uid and point_id='6' group by uid) as f from {users} as u where u.status='1'  order by uid DESC";

                 */


                $sump = $point_list[$p]['tpoints'];
                $tpoint = (!empty($sump)) ? $sump : 0;

                $bubble = load_bubble($puid);
                $outputppt .= ' <tr>
	<td height="40"><a rel=\'' . $bubble . '\' href="' . $gSitePath . 'profile/' . $point_list[$p]['name'] . '">' . $point_list[$p]['real_name'] . '</a></td>
	<td>' . $tpoint . '</td>
  </tr>';
            }
            $outputppt .= '</table>';



            break;
    }
    return $outputppt;
}

function gurupoints_cron(){

    global $gSitePath, $user, $gDocPath, $base_root, $base_path;

  	$user_pt = "SELECT uid FROM {users} where status='1'  ";

	 $point_list = ExecuteQuery($user_pt, "select");

         foreach($point_list as $list){
              db_query("DROP VIEW IF EXISTS {temp_scores}");
            $sel="CREATE VIEW {temp_scores} AS (select sum(score) as score,qid,1 as type,did as nid  from {debate} where uid='".$list['uid']."' group by did) union (select sum(dr.score)  as score,d.qid,2 as type,d.did as nid from {debate_reply} as dr join {debate} as d on d.did=dr.did where dr.uid='".$list['uid']."'  group by dr.rid) ";
             $point_list = ExecuteQuery($sel, "select");

             $query="select *,sum(score) as tscore from {temp_scores} group by qid";
               $tscore = ExecuteQuery($query, "select");
               foreach($tscore as $final){

               if($final['tscore']!=0){
               if(db_result(db_query("select count(*) from  {pundit_scores} where qid='".$final['qid']."'  and uid='".$list['uid']."'")))
                   db_query("update {pundit_scores} set score='".$final['tscore']."' where qid='".$final['qid']."' AND uid='".$list['uid']."'");
                   else
               db_query("insert into {pundit_scores} set qid='".$final['qid']."',uid='".$list['uid']."',score='".$final['tscore']."' ");
               }
               }
             update_ranking($list['uid']);
         }
}
function update_ranking($uid = ''){
    $total_points = db_result(db_query("SELECT SUM(points) as total_points FROM {tbl_user_points} WHERE uid = '$uid'"));
    $sql = "SELECT rank_id, ranking, points FROM tbl_ranking";
    $ranking[] = ExecuteQuery($sql,'select');
    // Citizen 200
    if($total_points < 5){
        $rank_id = '1';
    }
    // Active Citizen 200 499
    if($total_points >= 5 && $total_points < 10){
        $rank_id = '2';
    }
    // Judge 500 999
    if($total_points >= 10 && $total_points < 15){
        $rank_id = '3';
    }
    // Senator 1000
    if($total_points >= 15){
        $rank_id = '4';
    }
    db_query("UPDATE {users} SET rank_id = '$rank_id' WHERE uid = '$uid'" );
}
