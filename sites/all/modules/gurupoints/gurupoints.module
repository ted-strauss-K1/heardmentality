<?php
/**
 * Implementation of hook_perm().
 */
function gurupoints_perm() {
  return array('Add Points','list Points');
}


/**
 * Implementation of hook_menu().
 */
 
function gurupoints_menu() {	

$search_result['admin/addpoints'] = array(
    'title' => ' Add Points',
    'page callback' => 'add_points',
    'access arguments' => array('Add Points'),
    'type' => MENU_SUGGESTED_ITEM,
    'file' => 'gurupoints.pages.inc',
  );

$search_result['admin/point/save'] = array(
    'title' => ' Add Points',
    'page callback' => 'save_points',
    'access arguments' => array('Add Points'),
    'type' => MENU_SUGGESTED_ITEM,
    'file' => 'gurupoints.pages.inc',
  );
  
  $search_result['admin/userpoints'] = array(
    'title' => 'User Points',
    'page callback' => 'user_points',
    'access arguments' => array('list Points'),
    'type' => MENU_SUGGESTED_ITEM,
    'file' => 'gurupoints.pages.inc',
  );
  return $search_result;
}

function increasepoints($ptype,$qid,$idm)
{
 global $gSitePath,$user,$gDocPath,$base_root,$base_path;
	
	
	$queryuser= "SELECT * FROM user_profile where uid=$user->uid "; 
	$query_result=db_query($queryuser);
	$userresult=db_fetch_object($query_result);
	
	if($idm=='0')
	{
	$numpt= db_result(db_query("SELECT COUNT(*) from {tbl_user_points} where point_id='$ptype' and qid='$qid' and uid='$user->uid'"));
	  $query_pt= "SELECT * FROM tbl_points where id='$ptype' "; 
	$query_ptinfo=db_query($query_pt);
	$fetuserpts=db_fetch_object($query_ptinfo);
	
	if($numpt==0)
	{
	  $insert_pts="insert into tbl_user_points (uid,qid,point_id,points,vote_point_id) values($user->uid,$qid,$ptype,$fetuserpts->points,$idm)";
	$qus=db_query($insert_pts);
	$totpts=$userresult->points+$fetuserpts->points;
	$uppts="update user_profile set points=$totpts where uid=$user->uid";
	$quspts=db_query($uppts);
	}
	}
	else
	{
	//echo $idm;
	
	
	$cntr= db_result(db_query("SELECT COUNT(*) from {tbl_user_points} where vote_point_id='$idm' and qid='$qid' and uid='$user->uid'"));
	
	 $query_ptm ="select * from tbl_vote_gurupoints where id='".$idm."'"; 
	$query_ptinfo=db_query($query_ptm);
	$fetuserpts=db_fetch_object($query_ptinfo);
	
	
	
	if($cntr==0)
	{
	 $insert_pts="insert into tbl_user_points (uid,qid,point_id,points,vote_point_id) values($user->uid,$qid,$ptype,$fetuserpts->points,$idm)";
	$qus=db_query($insert_pts);
	$totpts=$userresult->points+$fetuserpts->points;
	$uppts="update user_profile set points=$totpts where uid=$user->uid";
	$quspts=db_query($uppts);
	}
	
	
	
	
	
	
	}
	

}


function insertpoints($action='',$nodeid='')
{
 global $gSitePath,$user,$gDocPath,$base_root,$base_path;
	
	if(!empty($nodeid)&&!empty($action)){
		$set=$action."='1'";
		//points 
			 $query_pt= "SELECT * FROM tbl_points where id='3' "; 
	$query_ptinfo=db_query($query_pt);
	$fetuserpts=db_fetch_object($query_ptinfo);
		$queryuser= "SELECT count(*) FROM {tbl_user_points}  where uid='$user->uid' AND $set AND nodeid='$nodeid' "; 
	$rcnt=db_result(db_query($queryuser));
	
	if($rcnt==0){
		
	db_query("insert into {tbl_user_points} set point_id='$fetuserpts->id',points='$fetuserpts->points',uid='$user->uid',$set,nodeid='$nodeid'");	
		
	}
	
		
	}
	
	

}


