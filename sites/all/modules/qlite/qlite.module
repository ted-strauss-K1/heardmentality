<?php
function qlite_perm() {
    
    return array('QLite', 'Report', 'Report Content', 'Ajax Content');

} // function newmodule_perm
function qlite_menu() {
    
    $item['qmini'] = array('title'=>'Question Lite', 'page callback'=>'qlitemini', 'access arguments'=>array('QLite'), 'type'=>MENU_CALLBACK, 'file'=>'qlite.pages.inc', );
    
    $item['qmini/report'] = array('title'=>'Question Lite', 'page callback'=>'qlite_report', 'type'=>MENU_CALLBACK, 'access arguments'=>array('Report'), 'file'=>'qlite.pages.inc', );
    $item['qmini/repcontent'] = array('title'=>'Question Lite', 'page callback'=>'report_content', 'type'=>MENU_CALLBACK, 'access arguments'=>array('Report Content'), 'file'=>'qlite.pages.inc', );
    $item['qmini/ajax'] = array('title'=>'Question Lite', 'page callback'=>'load_ajax', 'type'=>MENU_CALLBACK, 'access arguments'=>array('Ajax Content'), 'file'=>'qlite.pages.inc', );
     $item['qlite/tophot'] = array('title'=>'Question Lite', 'page callback'=>'tophot', 'access arguments'=>array('QLite'), 'type'=>MENU_CALLBACK, 'file'=>'qlite.pages.inc', );
    return $item;


}

//      $voutput .= '	  <div>
//              <h2>' . rtrim($oListquest->question, "?") . '? </h2>
//            </div>          <div class="quesin">
//              <div class="quesinner">
//                <div class="quesinnerr">
//<form id="answer_frm" name="answer_frm" method="post" action="' . $gSitePath . 'qlite/save"  >
//		 <input type="hidden" name="txt_act" id="txt_act" value=""/>
//	 <input type="hidden" name="mid" value="' . $qid . '"/>
//		<!--<div class=""><div class="lft_view"> <h4 class="cmt_name"><a></a></h4>-->
//
//		<!--<div>' . $shortdesc . ' ' . $linkj . '--><div>';
   // a{ text-decoration:none; color:#CC6600; font: normal Georgia, "Times New Roman", Times, serif;outline:none;}


function top_multimenu()
{
 global $gSitePath,$user,$gDocPath,$base_root;
drupal_add_js(drupal_get_path('module', 'qlite') . '/scripts/fade.js');
 drupal_add_js(drupal_get_path('module', 'qlite') . '/scripts/mostpopular.js');
    drupal_add_css(drupal_get_path('module', 'qlite') . '/css/mostpopular-basic.css');
   drupal_add_css(drupal_get_path('module', 'qlite') . '/css/mostpopular-full.css');



//    $voutput .= '<div class="clr"></div>
//	<div id="rotate">
//        <br/>
//              <ul id="maintabs" class="mytabs" >
//             <li class="current"><a href="" title="Report"><span>Top Questions</span></a></li>
//                <li class=""><a href="" title="Forum"><span>Hot Questions</span></a></li>
//              </ul>
//              <div class="mytabs-container" id="tabcontent">
//            Loading. Please Wait...
//        </div>
//           </div>';

   $voutput .=  '


      <div id="mostpop" class="mostpopular mostpopular--widget"><div class="item-list"><ul class="mostpopular--services">
<li class="selected"><a href="'.$gSitePath.'qlite/tophot/4/2" sid="4">Top</a></li>
<li class=""><a href="'.$gSitePath.'qlite/tophot/3/2" sid="3">Hot</a></li>
<li class="last"><a href="'.$gSitePath.'qlite/tophot/2/2" sid="2">Local</a></li>
</ul></div><div class="item-list"><ul class="mostpopular--intervals">
<li class=""><a href="'.$gSitePath.'qlite/tophot/4/1" iid="1">Day</a></li>
<li class="selected"><a href="'.$gSitePath.'qlite/tophot/4/2" iid="2">Week</a></li>
<li class=""><a href="'.$gSitePath.'qlite/tophot/4/3" iid="3">Month</a></li>
<li class="last"><a href="'.$gSitePath.'qlite/tophot/4/4" iid="4">Year</a></li>
</ul></div><div style="position: relative;"><div class="mostpopular--content" style="opacity: 1;"><p class="mostpopular--no-results">Loading...</p></div>
    <div class="ahah-progress ahah-progress-throbber" style="position: absolute; z-index: 100; display: none; top: 24px; left: 159px;">
    <div class="throbber">&nbsp;</div>
    </div>
</div></div>    
';

    
    return $voutput;
}



function tophot()
{
    //Array ( [0] => qlite [1] => tophot [2] => 4 [3] => 2 )
    $vars=arg();
  
    $output='';
    switch ($vars['2']){
        case '4':
            $output .= get_top_list($vars[3]);
            break;
        case '3':
            $output .= get_hot_list($vars[3]);
            break;
        case '2':
            $output .= get_local_list($vars[3]);
            break;
            default:
                $output.='No Result Found';
                break;
    }
    echo $output;
    exit;

}


function top_list() {
   
    drupal_add_js(drupal_get_path('module', 'qlite').'/scripts/qmini.js');
    $output = '';

$query = "SELECT * from {category} where parent_id='0' ORDER BY cat_name ASC";
    $list = ExecuteQuery($query, "select");





   /* $output .= '<div class="commutop">
        <div class="inner">
        <p style="color:white">COMMUNITY DISCUSSION</p>
            <div>
             <select id="tcat" onchange="get_toplist(this.value,1)"><option value="" >Select</option>';
    foreach ($list as $cat) {

        $output .= '
          <option value='.$cat['cat_id'].'> '.$cat['cat_name'].' </option> ';
    }
            $output .='</select>
              &nbsp;
              <span id="res_scat"><select name="" disabled="disabled">
                <option>selecct a sub-category</option>
              </select>
              </span>
            </div>
          </div>';*/


   
   $query = "SELECT * from {category} where parent_id='0' ORDER BY cat_name ASC";
    $list = ExecuteQuery($query, "select");
    $output .= ' <div> 
            <div>
            <select id="tcat" onchange="get_toplist(this.value,1)"><option value="" >Select</option>';
    foreach ($list as $cat) {

        $output .= '    
          <option value='.$cat['cat_id'].'> '.$cat['cat_name'].' </option> ';
    }
    
    $output .= '</select> &nbsp;  <span id="res_scat"><select name="" disabled="disabled">
                <option>selecct a sub-category</option>
              </select>
              </span></div> </div>';
             $output .= '
              <div class="inner"><div id="res_top">';


    //$output .= top_multimenu();

   $output .= get_top_list();
    
  $output .= get_hot_list();
    
  $output .= get_local_list();
    
  $output .= get_top_pundits();
    
      $output .= "</div></div>";

    
    return $output;


}

function get_top_pundits() {
    global $gSitePath,$user,$gDocPath,$base_root;
    drupal_add_css(drupal_get_path('module', 'qlite') . '/css/skin.css');
     drupal_add_js(drupal_get_path('module', 'qlite') . '/scripts/jquery.jcarousel.min.js');
    // drupal_add_js(drupal_get_path('module', 'qlite') . '/scripts/jquery.jcarousel.js');
     drupal_add_js(drupal_get_path('module', 'qlite') . '/scripts/page_jcarousel.js');
    $output = '';
   $cat_id = $_REQUEST['cid'];

    $output .= '
        
     <div class="facttop" align="center">PUNDITS</div>
      <div class="hm-cen-pun">';
   $output .= '<div>
       <div id="mycarousel" class="jcarousel-skin-tango">
           <ul>';
    if($cat_id!='')
    {
    $query = "select * from {follower} where cat_id='".$cat_id."'";
   
    $list = ExecuteQuery($query, "select");
    foreach ($list as $quest) {
         $udetails=load_user($quest['uid']);
         $bubble = load_bubble($udetails->uid);
          $output .= '<li><a rel=\''.$bubble.'\' href="'.$gSitePath.'/profile/'.$udetails->name.'">'.UserPicture($quest['uid']).'</a></li>';
           $page_incr = $page_incr + 1;

          if($page_incr==4)
          {
              $page .= '<a href="#">'.$pager.'</a>';
              $page_incr = 0;
              $pager = $pager + 1;
          }

        }
        
    }
    else
    {
    $query = "select count(*) from {gurulist}";
    $cnt=db_result(db_query($query));
     $limit=4;
     $total=round($cnt/$limit);
      $mod=$cnt%$limit;
      $mul=1;
    for($i=1;$i<=$total;$i++){
             
             $page .= '<a href="#" title="'.$mul.'">'.$i.'</a>';
             $mul=$mul+$limit;
                  $mul--;
       }
       if($mod)
           $page.='<a href="#" title="'.$mul.'">'.$i.'</a>';
    }
  $output_pager = '<span class="jcarousel-control">'.$page.'</span>';

    $output .= '</ul>
            </div>
           </div>';
    $output .= '</div>';
    
   $output .='<div class="jcarousel-scroll page-n2" align="center">
        <a href="#" id="mycarousel-prev">Previous &nbsp; <img alt="Previous" align="absmiddle" src="'.$gSitePath.  path_to_theme().'/images/p-l.jpg"></a>&nbsp;'.$output_pager.'<a href="#" id="mycarousel-next"><img alt="Next" align="absmiddle" src="'.$gSitePath.  path_to_theme().'/images/p-r.jpg"> &nbsp; Next</a>
        </div>


';
    return $output;

}
function get_top_list($time='') {
  
    global $gSitePath,$user,$gDocPath,$base_root;
    $output = '';
    $cond = '';
      $cond = load_condition();
      $output .= '<div>
         <h3><strong>Most active questions ever</strong></h3>
              <div class="innerbox" ><ul class="">';
   switch($time){
   case '1':
        $cond.=' AND DATE(date_added)="'.  date('Y-m-d').'" ';
       break;
   case '2':
        $cond.=' AND YEARWEEK(date_added)=YEARWEEK("'.  date('Y-m-d').'") ';
       break;
    case '3':
       $cond.=' AND MONTH(date_added)=MONTH("'.  date('Y-m-d').'") ';
       break;
    case '4':
      $cond.=' AND YEAR(date_added)=YEAR("'.  date('Y-m-d').'") ';
       break;
    default:
  
     break;

   }

       $query = "SELECT * from {question} as q join {user_profile} as u on u.uid=q.uid join question_cat as qcat on qcat.qid=q.qid where q.status='1' $cond group by qcat.qid order by q.active_rate  DESC LIMIT 0,10";

    $list = ExecuteQuery($query, "select");

    if (! empty($list)) {
        foreach ($list as $quest) {

            if(strlen($quest['question'])>40)
            {
                $bubble_question = 'rel="'. htmlentities(wordwrap($quest['question'], 40,'<br/>')).'"';
            }
            else
            {
                $bubble_question = '';
            }

            $output .=  '<li  class=""><a  '.$bubble_question.' href="'.$gSitePath.$quest['url'].'" style="'.drupal_link_color($user->uid,$quest['qid']).'">'.htmlentities(myTruncate($quest['question'], '40', '', '..')).'</a></li>';


        }
    } else {

        $output .= '<div><b>No Top List Found</b></div>';

    }
    $output .= '</ul></div> </div><div class="clr"></div>';
    return $output;
}

function get_hot_list($time='') {
    
    global $gSitePath,$user,$gDocPath,$base_root;
    $output = '';
    $cond = '';
    $cond = load_condition();
    
    $m = date("m");
    $de = date("d");
    $y = date("Y");
    $date = date('Y-m-d', mktime(0, 0, 0, $m, ($de - 7), $y));

    switch($time){
   case '1':
        $cond.=' AND DATE(date_added)="'.  date('Y-m-d').'" ';
       break;
   case '2':
        $cond.=' AND YEARWEEK(date_added)=YEARWEEK("'.  date('Y-m-d').'") ';
       break;
    case '3':
       $cond.=' AND MONTH(date_added)=MONTH("'.  date('Y-m-d').'") ';
       break;
    case '4':
      $cond.=' AND YEAR(date_added)=YEAR("'.  date('Y-m-d').'") ';
       break;
    default:

     break;

   }


   $query = "SELECT * from {question} as q join {user_profile} as u on u.uid=q.uid join question_cat as qcat on qcat.qid=q.qid where q.status='1' AND date(q.date_added) >= '$date' $cond group by qcat.qid order by q.active_rate  DESC LIMIT 0,10 ";
  // $query = "SELECT * from {question} as q join {user_profile} as u on u.uid=q.uid   where q.status='1' AND date(q.date_added) >= '$date' $cond order by q.active_rate  DESC LIMIT 0,10 ";
    $list = ExecuteQuery($query, "select");
    $output .= '<div>
        <h3><strong>Most active questions in the last seven days</strong></h3>
              <div class="innerbox" ><ul class="">';
    if (! empty($list)) {
        foreach ($list as $quest) {

            if(strlen($quest['question'])>40)
            {
                $bubble_question = 'rel="'. htmlentities(wordwrap($quest['question'], 40,'<br/>')).'"';
            }
            else
            {
                $bubble_question = '';
            }
            
            $output .= '<li class=""><a  '.$bubble_question.' href="'.$gSitePath.$quest['url'].'" style="'.drupal_link_color($user->uid,$quest['qid']).'">'.htmlentities(myTruncate($quest['question'], '40', '', '..')).'</a></li>';

        
        }
    } else {
        
        $output .= '<div><b>No Hot List Found</b></div>';
    
    }
      $output .= '</ul></div> </div><div class="clr"></div>';
    return $output;


}

function get_local_list($time='') {
    global $gSitePath,$user,$gDocPath,$base_root;
    $output = '';
    $cond = '';

    
    $cond = load_condition();
    
$country=my_country();
//print_r($country);
if(!empty($country)){
    if(!empty($country['cn'])){
       $query = array('query'=>$country['cn'],'maxRows'=>'1','featureclass'=>'S');
                $result = geonames_query('search', $query);
              //  print_r($result);
                $cc=$result->results[0]['countrycode'];
                $putcon=(!empty($cc))?$cc:trim($country['cn']);
$cond.=" AND q.country='".$putcon."'";
    }
if(!empty($country['state'])){

   $cond.=" OR q.state='".trim($country['state'])."'";
}
if(!empty($country['city'])){

   $cond.=" OR q.city='".trim($country['city'])."'";
}
}

 switch($time){
   case '1':
        $cond.=' AND DATE(date_added)="'.  date('Y-m-d').'" ';
       break;
   case '2':
        $cond.=' AND YEARWEEK(date_added)=YEARWEEK("'.  date('Y-m-d').'") ';
       break;
    case '3':
       $cond.=' AND MONTH(date_added)=MONTH("'.  date('Y-m-d').'") ';
       break;
    case '4':
      $cond.=' AND YEAR(date_added)=YEAR("'.  date('Y-m-d').'") ';
       break;
    default:

     break;

   }

// $homepage = file_get_contents('http://api.hostip.info/country.php');
  //  echo get_real_ip_addr();

  $query = "SELECT * from {question} as q join {user_profile} as u on u.uid=q.uid join question_cat as qcat on qcat.qid=q.qid where q.status='1'  $cond group by qcat.qid order by q.active_rate  ASC LIMIT 0,10 ";

   //$query = "SELECT * from {question} as q join {user_profile} as u on u.uid=q.uid  where q.status='1'  $cond order by q.active_rate  ASC LIMIT 0,10 ";
    $list = ExecuteQuery($query, "select");
    $output .= '<div>
             <h3><strong>Local questions</strong></h3>
              <div class="innerbox"><ul class="">';
    
    if (! empty($list)) {
        foreach ($list as $quest) {


            if(strlen($quest['question'])>40)
            {
                $bubble_question = 'rel="'. htmlentities(wordwrap($quest['question'], 40,'<br/>')).'"';
            }
            else
            {
                $bubble_question = '';
            }

            $output .=  '<li  class=""><a '.$bubble_question.' href="'.$gSitePath.$quest['url'].'" style="'.drupal_link_color($user->uid,$quest['qid']).'">'.htmlentities(myTruncate($quest['question'], '40', '', '..')).'</a></li>';
        
        }
    } else {
        
        $output .= '<div><b>No Local List Found</b></div>';
    
    }
	   $output .= '</ul></div> </div><div class="clr"></div>';
    return $output;


}

function my_country(){
 global $gSitePath,$user,$gDocPath,$base_root,$base_path;
         $url= 'http://ipinfodb.com/ip_query_country.php?ip='.get_real_ip_addr();
     $curl = curl_init();
     $list=array();
// Setup the curl settings
curl_setopt($curl, CURLOPT_URL, $url);
curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
curl_setopt($curl, CURLOPT_CONNECTTIMEOUT, 0);

// grab the XML file
$raw_xml = curl_exec($curl);

curl_close($curl);

// Setup the xml object
$xml =(array)simplexml_load_string( $raw_xml );
//print_r($xml);
if(!empty($user)){

  $details=load_user($user->uid);

}
$list['cc']=(!empty($details->country))?$details->country:$xml['CountryCode'];
$list['cn']=(!empty($details->country))?$details->country:$xml['CountryName'];
$list['state']=(!empty($details->state))?$details->state:$xml['RegionName'];
$list['city']=(!empty($details->city))?$details->city:$xml['City'];
/*
 *
 * <Ip>74.125.45.100</Ip>
    <Status>OK</Status>
    <CountryCode>US</CountryCode>
    <CountryName>United States</CountryName>
    <RegionCode>06</RegionCode>
    <RegionName>California</RegionName>
    <City>Mountain View</City>
    <ZipPostalCode>94043</ZipPostalCode>
    <Latitude>37.4192</Latitude>
    <Longitude>-122.057</Longitude>
    <Timezone>0</Timezone>
    <Gmtoffset>0</Gmtoffset>
    <Dstoffset>0</Dstoffset> 
 */

return $list;
}


function get_real_ip_addr()
{
if(!empty($_SERVER['HTTP_CLIENT_IP']))   //check ip from share internet
{
$ip=$_SERVER['HTTP_CLIENT_IP'];
}
else if(!empty($_SERVER['HTTP_X_FORWARDED_FOR']))   //to check ip is pass from proxy
{
$ip=$_SERVER['HTTP_X_FORWARDED_FOR'];
}
else
{
$ip=$_SERVER['REMOTE_ADDR'];
}

return $ip;
}
function cal_active_rate() {

    
    global $gSitePath,$user,$gDocPath,$base_root;
    $j = 5;
    $k = 5;
    $l = 5;
    $fcnt = array();
    $gvote = array();
    $query = "SELECT * from {question}";
    $list = ExecuteQuery($query, "select");
    
    foreach ($list as $quest) {

        
        $query1 = "select IFNULL((select count(*) from {possible_answer_vote} as pa where q.qid=pa.qid group by pa.qid ),0) as pvote,(select count(*) from {suggest_answer_vote} as sa where q.qid=sa.qid group by sa.qid ) as svote from {question} as q where q.qid='".$quest['qid']."'";
        $gvote = ExecuteQuery($query1, "select");
        $m1 = $gvote[0]['pvote'];
        $m2 = $gvote[0]['svote'];
        
    $tvote = $m1 + $m2;
        
        $query2 = "select IFNULL((select count(*) from {forum_wavelets} as w where w.wid=f.fid group by w.wid),0) as wcnt,IFNULL((select count(*) from {resource} where qid='".$quest['qid']."' group by qid),0) as rcnt from {forum_wave} as f where f.qid_rid='".$quest['qid']."' ";
       echo $fcnt = db_fetch_object(db_query($query2));
        
        //The value �active� will be calculated as follows (j,k,l are constant values that will be hard-coded):
        //Active =  (j * #_of_votes_for_question) + (k * #_of_forum_posts) + (l * #_of_posted_resources)
        if (! empty($fcnt)) {
            $cntr = $fcnt->wcnt;
            $wcnt = $fcnt->rcnt;
            $active = (($j * $tvote) + ($k * $cntr) + ($l * $wcnt));
            db_query("update {question} set active_rate='".$active."' where qid='".$quest['qid']."'");
        }

    
    }

}
function load_condition() {
    $cond = '';
    //print_r($_REQUEST);
    if (isset($_REQUEST['cid']) && isset($_REQUEST['action'])) {
        extract($_REQUEST);
        if (! empty($cid)) {
            
            //$cond .= " AND q.cid='$cid'";
            $cond .= " AND qcat.cat='$cid'";
           //$cond .= " AND qcat.cat IN()";
        }
        
        if (! empty($scid)) {
            
            //$cond .= " AND q.scid='$scid'";
           $cond .= " AND qcat.scat='$scid'";
        }
    
    }
    
    return $cond;

}