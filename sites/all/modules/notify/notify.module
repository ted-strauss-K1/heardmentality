<?php
/**
 * Implementation of hook_perm().
 */
function notify_perm() {
  return array('notify','Notify Report','Notify Report Content','Notify Report Content2','Notify Report Content3','Admin Notification');
}


/**
 * Implementation of hook_menu().
 */
 
function notify_menu() {	

$items['mynotify'] = array(
    'title' => 'Notification',
    'page callback' => 'my_notify_list',
    'access arguments' => array('notify'),
    'type' => MENU_SUGGESTED_ITEM,
    'file' => 'notify.pages.inc',
  );

 $items['notify/report'] = array(
    'title' => 'Notification',
    'page callback' => 'notify_report',
	   'type' => MENU_CALLBACK,
	   'access arguments' => array('Notify Report'),
    'file' => 'notify.pages.inc',
  );
  $items['notify/repcontent'] = array(
    'title' => 'Notification',
    'page callback' => 'notify_content',
	   'type' => MENU_CALLBACK,
	   'access arguments' => array('Notify Report Content'),
    'file' => 'notify.pages.inc',
  );
 $items['message'] = array(
    'title' => 'Notification',
    'page callback' => 'mail_sent_reply',
	   'type' => MENU_CALLBACK,
	   'access arguments' => array('Notify Report Content2'),
    'file' => 'notify.pages.inc',
  );
  $items['reply'] = array(
    'title' => 'Notification',
    'page callback' => 'reply_box',
	   'type' => MENU_CALLBACK,
	   'access arguments' => array('Notify Report Content3'),
    'file' => 'notify.pages.inc',
  );
  
    $items['admin/notification'] = array(
    'title' => 'Change Notification Mail',
    'page callback' => 'admin_notify',
	   'type' => MENU_SUGGESTED_ITEM,
	   'access arguments' => array('Admin Notification'),
    'file' => 'notify.pages.inc',
  );
  
  
  
  $items['admin/save_notify'] = array(
    'title' => 'Notification',
    'page callback' => 'admin_notify_save',
	   'type' => MENU_CALLBACK,
	   'access arguments' => array('Admin Notification'),
    'file' => 'notify.pages.inc',
  );
  
  
  
  
  
  
  
  return $items;
}







function forum_post() {
    global $gSitePath,$user;
    
	$output = '';

        $sel_follow="select * from follower where uid='".$user->uid."' and follower_id!='' order by id desc limit 0,5";
       
         $get_follow = db_query($sel_follow);
         

		  $output .= '<div id=""><ul>';
                
  while($fet_follow = db_fetch_object($get_follow))
  {
      $output.='<li>';
      $vSql = "select * from question where uid='".$fet_follow->follower_id."' order by qid desc limit 0,5";
         
          $sql_follow = db_query($vSql);
          while($sql_fet = db_fetch_object($sql_follow))
          {
            $output .='<div><a href="'.$gSitePath.$sql_fet->url.'">'. substr($sql_fet->question,0,20).'...'.'</a></div>';

            $forum_query = "select * from forum_wave where qid_rid='$sql_fet->qid' order by fid desc limit 0,5";

            $forum_list = ExecuteQuery($forum_query, "select");

             foreach ($forum_list as $list) {
                 $click = 'loadwave('.$list['qid_rid'].','.$list['fid'].')';
                 
                  $output.='
                    <div><a href="javascript:void(0);" onclick="'.$click.'" style="color: black">'.$list['title'].'</a><div>';
             }

          }
           $output.='</li>';
  }
        $output.='</ul></div>';

//	 $vSql = "select *,q.uid as uid from {question} as q left join {user_profile} as u on q.uid=u.uid where  q.qid='" . $qid . "'  ";
//	    $rlist = db_query($vSql);
//    $oListquest = db_fetch_object($rlist);
//
//
//
//            $output .= '<div id="container">';
//             $output .='<div class="feature">';
//		$output .= '<div class="l col">';
//		//$output .= '<ul>';
//	$output .='<div><a href="'.$gSitePath.$oListquest->url.'">'. substr($oListquest->question,0,20).'...'.'</a></div>';
//
//
//
//
//    $follow_query = "select * from follower where uid='$user->uid'";
//
//    $follow_list=db_query($follow_query);
//$followid=db_fetch_object($follow_list);
//
// $forum_query = "select * from forum_wave where uid='$followid->uid' and qid_rid='$oListquest->qid' order by fid desc limit 0,3";
//
//
// $forum_list = ExecuteQuery($forum_query, "select");
//
// foreach ($forum_list as $list) {
//
//       // $output .= '<div>'.$list['title'].'</div>';
//      $click = 'loadwave('.$list['qid_rid'].','.$list['fid'].')';
//
//       $output.='
//	<div><a href="javascript:void(0);" onclick="'.$click.'">'.$list['title'].'</a><div>';
//    }
// $output .='</div>
//	</div>
//	</div>';

    return $output;
}



function notify_category()
{

 global $gSitePath,$user,$gDocPath,$base_root,$base_path;

 $sel_follow="select * from follower where uid='".$user->uid."' and follower_id!=''";
 

  $get_follow = db_query($sel_follow);
  while($fet_follow = db_fetch_object($get_follow))
  {
  
	//$sel_flow="select * from follower where uid='".$user->uid."' and  cat_id!=''";
   /* $sel_flowcount="select count(*) as count from follower where uid='".$fet_follow->follower_id."' and  cat_id!=''";
    $rs_folquery = db_query($sel_flowcount);
    $rs_folfet=db_fetch_object($rs_folquery);*/

    
        $sel_flow="select * from follower where uid='".$fet_follow->follower_id."' and  cat_id!=''";
       
     
        
	$rs_folwin=db_query($sel_flow);
	$questlist='<div class="">
		<ul>';
       $chk = '';
	while($flwing_result=db_fetch_object($rs_folwin))
	{

	//$questlist.=' '.$flwing_result->cat_name.'';

	$sel_suge="select * from category  where cat_id=".$flwing_result->cat_id."  ";
	$mm=db_query($sel_suge);

	$ans_result=db_fetch_object($mm);
	//$questlist.=' '.$ans_result->cat_name.'<br/>';

 //$queslist .='<div><a href="'.$gSitePath.'/searchquestion?cid='.$ans_result->cat_id.'">'.$ans_result->cat_name.'</a></div>';
        $questlist .='<li><a href="'.$gSitePath.'searchquestion?cid='.$ans_result->cat_id.'">'.$ans_result->cat_name.'</a></li>';
        //echo $ans_result->cat_name;

	}
  }


$questlist.='</ul></div>';
     if(count($flwing_result)<1)
      {
          $questlist = "No records";
      }

	return $questlist;
}







function notify_questions()
{

 global $gSitePath,$user,$gDocPath,$base_root,$base_path;

 $sel_follow="select * from follower where uid='".$user->uid."' and follower_id!=''";
 
  $get_follow = db_query($sel_follow);
 while($fet_follow = db_fetch_object($get_follow))
  // $fet_follow->follower_id;
 {

  /* $sel_flowcount="select * from follower where uid='".$fet_follow->follower_id."' and question_id!=''";
  
    $rs_folquery = db_query($sel_flowcount);
    $rs_folfet=db_fetch_object($rs_folquery);*/


	//$sel_flow="select * from follower where uid='".$user->uid."' and question_id!=''";
        $sel_flow="select * from follower where uid='".$fet_follow->follower_id."' and question_id!=''";
     

	$rs_folwin=db_query($sel_flow);
	$questlist='
		<div id="">
		
		<ul>';
       $chk = '';
	while($flwing_result=db_fetch_object($rs_folwin))
	{

	//$questlist.=' '.$flwing_result->cat_name.'';
        $questlist.='<li>';
              $sel_count="select count(*) as count from possible_answer_vote  where qid=".$flwing_result->question_id."";
              $ss = db_query($sel_count);
              $sel_result=db_fetch_object($ss);
              if($sel_result->count!='')
              {

	 $sel_suge="select * from question  where qid=".$flwing_result->question_id."  ";
        
     
	$mm=db_query($sel_suge);

	$ans_result=db_fetch_object($mm);
              }
	//$questlist.=' '.$ans_result->cat_name.'<br/>';

 //$queslist .='<div><a href="'.$gSitePath.'/searchquestion?cid='.$ans_result->cat_id.'">'.$ans_result->cat_name.'</a></div>';
        $questlist .='<div><a href="'.$gSitePath.$ans_result->url.'">'.$ans_result->question.'</a></div>';
         $questlist.='</li>';
	}
 }

$questlist.='</ul></div>';
//        if($rs_folfet->count==0)
//        {
//            $questlist = "No records";
//        }

	return $questlist;
}


function notify_questionstop(){  
     global $gSitePath,$user,$gDocPath,$base_root,$base_path;

$numrancntss = db_result(db_query("SELECT COUNT(*)  from notification as a, question as b  where a.uid=".$user->uid." and a.follower_action='1'  and a.is_question='1' and a.node_id=b.qid  and b.status='1'  order by a.nid desc  "));

 $numrancntss;

	 $sel_flow="select * from notification as a, question as b  where a.uid=".$user->uid." and a.follower_action='1'  and a.is_question='1' and a.node_id=b.qid  and b.status='1'  order by a.nid desc ";

	$rs_folwin=db_query($sel_flow);
	$questlist='
		<form id="cmtform" name="cmtform" method="post" action="'.$gSitePath.'question/reply" ><div id="container">
		<div class="feature">
		<div class="l col">
		<ul>';
       $chk = '';
       $i=0;
	while($flwing_result=db_fetch_object($rs_folwin))
	{

	$sel_ulist = "SELECT * FROM users LEFT JOIN user_profile ON users.uid=user_profile.uid Where users.uid='".$flwing_result->uid."'";
	$rs_umlog=db_query($sel_ulist);
	$user_namelistf=db_fetch_object($rs_umlog);

	$sel_suge="select * from possible_answer  where qid=".$flwing_result->qid."  ";
	$mm=db_query($sel_suge);


		$questlist.='<li>
	<h3><input type="checkbox" class="check-me" name="usids['.$i.']" value="'.$flwing_result->uid.'" /> <a href="'.$gSitePath.'profile/'.$user_namelistf->name.'" style="'.drupal_link_color($user->uid,$flwing_result->qid).'"> '.$user_namelistf->name.' </a> <br><a href="'.$gSitePath.'notify/'.$flwing_result->url.'">'.substr($flwing_result->question,0,10).'</a>      </h3><div>'.$flwing_result->context.'</div>
	';

	   $numrand = db_fetch_object(db_query("SELECT * from {possible_answer_vote} where qid=".$flwing_result->qid." and uid=".$user->uid." "));

  $seltd = '';
	while($ans_result=db_fetch_object($mm))
	{
	 $seltd = '';
   if ($numrand->panswer_id ==$ans_result->paid)
     {
	 $seltd='checked="checked"';
     }
	$questlist.=' <input name="'.$flwing_result->qid.'" type="radio" value="'.$ans_result->paid.'" '.$seltd.' />'.$ans_result->answer.'<br>';

	}
        $i++;
	}

$questlist.='</ul></div>
	</div>

	</div>
	';
	if($numrancntss==0)
	{
	$questlist='No Notifications';
	}
	else
	{
	$questlist.='<div><div id="clist"></div><div id="showbox_cmt" align="left" style="width:100%;display:none"><label for="cmt_txt"><b> Message :</b></label><br/><textarea name="cmt_txt" cols="55" row="17" id="cmt_txt"></textarea><input type="hidden" id="action" name="action" value="1"/> </div><input type="button" name="Votes" value="Votes" onclick="get_votes(1);"/>
	<input type="button" name="Reply" value="Reply" onclick="get_Reply();"/>
	</div>';
        $questlist.=' </form>';
	}
	
	//echo $questlist
        return $questlist;    
}


function notify_suggest_follow()
{
    global $gSitePath,$user, $gDocPath,$base_root,$base_path;
	$sel_flow="select * from follower  where uid='".$user->uid."'  and follower_status='1' ";
	$rs_folwin=db_query($sel_flow);
	$array2=array();
	$array1=array();
	while($flwing_result=db_fetch_object($rs_folwin))
	{

	array_push($array2,$flwing_result->follower_id);

	$sel_suge="select * from follower  where uid='".$flwing_result->follower_id."' and follower_id!='".$user->uid."' and follower_status=1 limit 0,5";

	$rs_suges=db_query($sel_suge);

	while($suggest_list=db_fetch_object($rs_suges))
	{


	array_push($array1,$suggest_list->follower_id);

	}
	}


	$reult = array_diff($array1, $array2);


		$result_array=array_values($reult);
		if(count($result_array)!=0)
		{
		$suggest_follow='
		<div class="">
		<ul>';

		for($m=0;$m<count($result_array);$m++)
		{
		 $user_listsm="select * from {users} where status='1' and uid='$result_array[$m]'";
		$user_qrylist=db_query($user_listsm);
		$user_resultry=db_fetch_object($user_qrylist);

		$suggest_follow.='<li>
	<a href="'.$gSitePath.'profile/'.$user_resultry->name.'">'.$user_resultry->name.'</a></li>';




	}

	$suggest_follow.='</ul></div>
	
	';
	}
	else
	{
	$suggest_follow='No Records';


	}

	return $suggest_follow;
}

function notify_pundits()
{

 global $gSitePath,$user,$gDocPath,$base_root,$base_path;

 $sel_follow="select * from follower where uid='".$user->uid."' and follower_id!=''";


  $get_follow = db_query($sel_follow);
  while($fet_follow = db_fetch_object($get_follow))
  {





	//$sel_flow="select * from follower where uid='".$user->uid."' and  cat_id!=''";
   /* $sel_flowcount="select count(*) as count from follower where uid='".$fet_follow->follower_id."' and  cat_id!=''";
    $rs_folquery = db_query($sel_flowcount);
    $rs_folfet=db_fetch_object($rs_folquery);*/


        $sel_flow="select * from follower where uid='".$fet_follow->follower_id."' and  cat_id!=''";



	$rs_folwin=db_query($sel_flow);
	$questlist='
		<div id="container">
		<div class="feature">
		<div class="l col">
		<ul>';
       $chk = '';
	while($flwing_result=db_fetch_object($rs_folwin))
	{

	//$questlist.=' '.$flwing_result->cat_name.'';

	$sel_suge="select * from category  where cat_id=".$flwing_result->cat_id."  ";
	$mm=db_query($sel_suge);

	$ans_result=db_fetch_object($mm);
	//$questlist.=' '.$ans_result->cat_name.'<br/>';

 //$queslist .='<div><a href="'.$gSitePath.'/searchquestion?cid='.$ans_result->cat_id.'">'.$ans_result->cat_name.'</a></div>';
        $questlist .='<div><a href="'.$gSitePath.'searchquestion?cid='.$ans_result->cat_id.'">'.$ans_result->cat_name.'</a></div>';
        //echo $ans_result->cat_name;

	}
  }


$questlist.='</ul></div>
	</div>
	</div>
	';
//        if($rs_folfet->count==0)
//        {
//            $questlist = "No records";
//        }

	return $questlist;
}



////follower action

function notify_followerquestions()
{

 global $gSitePath,$user,$gDocPath,$base_root,$base_path;
$followlist = '';
 $sel_follow="select * from follower where follower_id='".$user->uid."' and cat_id=0 and question_id=0 order by id desc";

  $get_follow = db_query($sel_follow);
  $followlist='<div class=""><ul>
		';
  while($fet_follow = db_fetch_object($get_follow))
  {

        $sel_ques="select * from question  where uid='".$fet_follow->uid."' order by qid desc ";
	$rs_ques=db_query($sel_ques);
	
       
	while($fet_ques=db_fetch_object($rs_ques))
	{

          
           $loadques = load_question($fet_ques->qid);

            //$followlist .=  $loadques[2];
            
           
          $followlist .='<li><a href="'.$gSitePath.$loadques[url].'" title="'.wordwrap($loadques[2],40, "<br/>").'">'.htmlentities(substr($loadques[2],0,40)).'....'.'</a></li>';
	}
       
  }
   $followlist.='</ul></div>';



     if(count($fet_ques)<1)
      {
          $followlist = "No records";
      }

	return $followlist;
}




/////////follower notify answer

function notify_followeranswer()
{

 global $gSitePath,$user,$gDocPath,$base_root,$base_path;

 $followans="select * from follower where follower_id='".$user->uid."' and cat_id=0 and question_id=0 order by id desc";

  $get_followans = db_query($followans);
  $anslist='<div class="">
		<ul>';
  while($fet_followans = db_fetch_object($get_followans))
  {

          $sel_ans="select * from possible_answer_vote  where uid='".$fet_followans->uid."'";
         
	$rs_ans=db_query($sel_ans);
	

	while($fet_ans=db_fetch_object($rs_ans))
	{


          // $loadques = load_question($fet_ques->qid);
            $fet_ans->panswer_id;
            $fet_ans->qid;

            $poss_qry = "select * from  possible_answer as pa join possible_answer_vote as pv on pa.paid=pv.panswer_id where pa.qid='".$fet_ans->qid."' order by pv.vote_pid desc";
            $possrs = db_query($poss_qry);
           $possfet =  db_fetch_object($possrs);

           //$anslist .= $possfet->answer;

          $anslist .='<li><a title="'.wordwrap($possfet->answer,40, "<br/>").'">'.htmlentities(substr($possfet->answer,0,40)).'</a></li>';

	/*$sel_suge="select * from category  where cat_id=".$flwing_result->cat_id."  ";
	$mm=db_query($sel_suge);

	$ans_result=db_fetch_object($mm);

        $followlist .='<li><a href="'.$gSitePath.'searchquestion?cid='.$ans_result->cat_id.'">'.$ans_result->cat_name.'</a></li>';*/
	}
  }


$anslist.='</ul></div>';
     if(count($fet_ans)<1)
      {
          $anslist = "No records";
      }

	return $anslist;
}

///// follower like forum


function notify_followerlike()
{

 global $gSitePath,$user,$gDocPath,$base_root,$base_path;

 $followlike="select * from follower where follower_id='".$user->uid."' and cat_id=0 and question_id=0 order by id desc";

  $get_followlike = db_query($followlike);
  $likelist='<div class=""><ul>';
  while($fet_followlike = db_fetch_object($get_followlike))
  {

        $sel_like="select * from user_likes where uid='".$fet_followlike->uid."' and is_wave='1' and is_like='1'";

	$rs_like=db_query($sel_like);


	while($fet_like=db_fetch_object($rs_like))
	{


          // $loadques = load_question($fet_ques->qid);
            

             $forum_qry = "select * from forum_wave where fid='".$fet_like->node_id."' order by fid desc";
            $forumrs = db_query($forum_qry);
           $forumfet =  db_fetch_object($forumrs);

            $click = 'loadwave('.$forumfet->qid_rid.','.$forumfet->fid.')';

       $likelist.='<li><a href="javascript:void(0);" onclick="'.$click.'" style="color: black">'.$forumfet->title.'</a></li>';
        //$likelist .='<li><a title="'.wordwrap($forumfet->title,40, "<br/>").'">'.htmlentities(substr($forumfet->title,0,40)).'</a></li>';
	}
  }


$likelist.='</ul></div>';
     if(count($fet_like)<1)
      {
          $likelist = "No records";
      }

	return $likelist;
}
///////////////////  notify New answer approved on previously answered question


/*function notify_answeredques()
{
 global $gSitePath,$user,$gDocPath,$base_root,$base_path;






 $possible_qry = "select * from possible_answer_vote where uid!='".$user->uid."' group by qid";
 $possible_res = db_query($possible_qry);

 $answeredlist='<div class=""><ul>';
 
  while($possible_rows = db_fetch_object($possible_res))
  {
            $possible_rows->qid;
            $possible_rows->uid;
            $possible_rows->panswer_id;

            $ques_qry = "select * from question where qid='".$possible_rows->qid."'";
            $ques_res = db_query($ques_qry);
            $ques_rows = db_fetch_object($ques_res);
            
            $ques_rows->question;

            $poss_qry = "select * from possible_answer where paid='".$possible_rows->panswer_id."'";
            $poss_res = db_query($poss_qry);
            $poss_rows = db_fetch_object($poss_res);

            $poss_rows->answer;


             $answeredlist .='<div align="left"><a href="'.$gSitePath.$ques_rows->url.'">'. substr($ques_rows->question,0,20).'...'.'</a></div>';


             $answeredlist .='<div style="color:black">'. substr($poss_rows->answer,0,20).'...'.'</div>';
  }

$answeredlist.='</ul></div>';




     if(count($possible_rows)<1)
      {
          $answeredlist = "No records";
      }

	return $answeredlist;
}*/

function notify_answeredques()
{
    global $gSitePath,$user,$gDocPath,$base_root,$base_path;

   $possible_qry = "select * from possible_answer_vote where uid='".$user->uid."'";
  
    $possible_res = db_query($possible_qry);
    
    $answeredlist='<div class=""><ul>';

  while($possible_rows = db_fetch_object($possible_res))
  {
            if($possible_rows->qid)
            {
           $q_qry = "select * from possible_answer_vote where qid = '".$possible_rows->qid."' and  uid !='".$user->uid."' group by qid order by vote_pid desc limit 0,5";
            }

           $q_res = db_query($q_qry);
         while($q_rows = db_fetch_object($q_res))
         {
      
            if($q_rows->qid)
            {
            $ques_qry = "select * from question where qid='".$q_rows->qid."'";
            $ques_res = db_query($ques_qry);
            $ques_rows = db_fetch_object($ques_res);

            

            /*$poss_qry = "select * from possible_answer where paid='".$q_rows->panswer_id."'";
            $poss_res = db_query($poss_qry);
            $poss_rows = db_fetch_object($poss_res);*/

           


             $answeredlist .='<div align="left"><a href="'.$gSitePath.$ques_rows->url.'">'. substr($ques_rows->question,0,40).'...'.'</a></div>';
            }
             //$answeredlist .='<div style="color:black">'. substr($poss_rows->answer,0,20).'...'.'</div>';
         }
   
  }
  $answeredlist.='</ul></div>';

  if(count($q_rows)<1)
      {
          $answeredlist = "No records";
      }

	return $answeredlist;


}
////////////////notify flagged question
function notify_flagged()
{
    global $gSitePath,$user,$gDocPath,$base_root,$base_path;

    $flag_qry = "select qf.* from question_flags as qf join question as q on qf.nodeid!=q.qid and qf.uid!='".$user->uid."' group by qf.nodeid desc limit 0,5";
    $flag_res = db_query($flag_qry);

    $flaggedlist='<div class=""><ul>';

  while($flag_rows = db_fetch_object($flag_res))
  {
    
 $flaggedlist .='<div align="left">'.$flag_rows->abuse_type.' / '. date("D j M Y", strtotime($flag_rows->flag_date)).'</div>';
      
  }
  
  $flaggedlist.='</ul></div>';

  if(count($flag_rows)<1)
      {
          $flaggedlist = "No records";
      }

	return $flaggedlist;


}

