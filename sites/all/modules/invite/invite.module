<?php

/**
 * Implementation of hook_perm().
 */
function invite_perm() {
    return array('Invite Friends', 'Twitter Login');
}

/**
 * Implementation of hook_menu().
 */
function invite_menu() {

    $items['invite/invite_friends'] = array(
        'title' => ' Invite Friends',
        'page callback' => 'invite_friends',
        'access arguments' => array('Invite Friends'),
        'type' => MENU_CALLBACK,
        'file' => 'invite.pages.inc',
    );
    $items['twitter/post'] = array(
        'title' => ' Twitter ',
        'page callback' => 'twitter_login',
        'access arguments' => array('Twitter Login'),
        'type' => MENU_CALLBACK,
        'file' => 'invite.pages.inc',
    );

    $items['twitterpost'] = array(
        'title' => ' Twitter ',
        'page callback' => 'twitterpost_save',
        'access arguments' => array('Twitter Login'),
        'type' => MENU_CALLBACK,
        'file' => 'invite.pages.inc',
    );
    $items['invite/sendmail'] = array(
        'title' => 'sendmail',
        'page callback' => 'invite_cron',
        'access arguments' => array('Twitter Login'),
        'type' => MENU_CALLBACK,
        'file' => 'invite.pages.inc',
    );


    return $items;
}

function htmlmail($to, $subject, $message, $from='', $headers = NULL) {
    global $gSitePath, $user, $gDocPath, $base_root, $base_path;
    $from = variable_get('site_mail');

    $ins_qry = "insert into hm_mails(from_mail_id,user_from_id,user_to_id,subject,content,mail_status,posted_date)values('$from','$from','$to','" . $subject . "','" . $message . "',0,now())";
    db_query($ins_qry);
    return true;
}

function htmlmail_function($to, $subject, $message, $headers = NULL) {
 global $gSitePath, $user, $gDocPath, $base_root, $base_path,$base_url, $theme_path, $theme, $conf;
    
   
    $from = variable_get('site_mail');
// To send HTML mail, the Content-type header must be set
    $path =$base_url.'/'.drupal_get_path('theme', $theme);

    $newmessage = '';

    // To send HTML mail, the Content-type header must be set
    $headers = 'MIME-Version: 1.0' . "\r\n";
    $headers .= 'Content-type: text/html; charset=iso-8859-1' . "\r\n";
    $headers .= 'From: ' . $conf['site_name'] . ' <' . $conf['site_mail'] . '>' . "\r\n";

    $newmessage .= '
			   <html>
				<head>
				 <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
				 <title>' . $conf['site_name'] . '</title>
				 <style type="text/css">
				  <!--
				   *{ margin:0px; padding:0px;}
					body{ margin:0px; padding:0px;font:normal 12px Arial, Helvetica, sans-serif;}
					img{ border:none; outline:none;}
					a{ color:#000; text-decoration:none;}
					a:hover{ text-decoration:underline;}
					.clr{ clear:both;}

					#email-main{ width:622px; margin:0 auto; min-height:200px; height:auto !important; height:200px; border:2px #8f8c8c solid;}
					#email-main #header{ background:#8f8c8c; padding:7px 0px; padding-left:10px;}
					#email-main #header .email-logo{ background:url('.$path . '/images/email-logo.jpg) no-repeat; width:229px; height:27px;}
					#email-main #content{ margin:0px; padding:10px;}
					#email-main #content h1{ font:normal 22px Arial, Helvetica, sans-serif; color:#000; text-decoration:none;}
					#email-main #content h1 a{ font:normal 22px Arial, Helvetica, sans-serif; color:#000; text-decoration:none;}
					#email-main #content h1 a:hover{ font:normal 22px Arial, Helvetica, sans-serif; color:#000; text-decoration: underline;}
					#email-main #content h3{ font:normal 16px Arial, Helvetica, sans-serif; color:#666; text-decoration: underline;}
					#email-main #content p{ font:bold 13px Arial, Helvetica, sans-serif; color:#666666; padding:5px 0px;}
					#email-main #content p strong{ font:normal 12px Arial, Helvetica, sans-serif; color:#666666; padding:5px 0px;}
					#email-main #content h2 { font:bold 13px Arial, Helvetica, sans-serif; color:#000; padding-bottom:10px; text-decoration:none;}
					#email-main #content h2 a{ font:bold 13px Arial, Helvetica, sans-serif; color:#000; padding-bottom:10px; text-decoration:underline;}
					#email-main #content h2 a:hover{ text-decoration:none;}
					a{ color:#000; text-decoration:underline; font:bold 12px Arial, Helvetica, sans-serif; color: #960;}
					a:hover{ text-decoration:none;}
					#email-main #content b{ font:normal 11px Arial, Helvetica, sans-serif; color:#666666;}
					#email-main #content .avatar-intro{ width:290px; min-height:100px; height: auto !important; height:100px; padding:10px; background:#fafafa; border:1px #ccc solid; margin-top:10px; margin-bottom:10px;}
					#email-main #content .avatar-intro ul{ padding:10px;}
					#email-main #content .avatar-intro ul li{ float:left; list-style:none; font:bold 12px Verdana, Geneva, sans-serif; color:#000; padding:5px 10px; border-right:1px #ccc solid;}
					#email-main #content .avatar-intro ul .border-none{ border:none;}
					#email-main #content .avatar-intro ul li strong{font:bold 12px Verdana, Geneva, sans-serif; color:#999;}
					#email-main #content .avatar-intro ul li a{ float:left; list-style:none; font:bold 12px Verdana, Geneva, sans-serif; color:#000;}
					#email-main #content .avatar-intro ul li a:hover{ float:left; list-style:none; font:bold 12px Verdana, Geneva, sans-serif; color:#000; text-decoration:underline;}
					#email-main #content .avatar-intro-left{ float:left; width:70px;}
					#email-main #content .avatar-intro-right{ float:left; width:200px;}
					#email-main #content .avatar-box{ width:590px; background:#f0f0f0; padding:7px; margin-top:10px; border-bottom:1px #999 dotted; border-top:1px #999 dotted; margin-bottom:5px;}
					#email-main #content .avatar-box .avatar-box-left{ float:left; width:70px;}
					#email-main #content .avatar-box .avatar-box-left img{ border:1px #ccc solid;}
					#email-main #content .avatar-box .avatar-box-right{ float:left; width:478px; padding-left:10px;}
					.email-btn{ background:url(' . $path . '/images/email-btn-bg.jpg) repeat-x; padding:4px 10px; border:none; cursor:pointer; font:normal 17px Arial, Helvetica, sans-serif; color:#fff; text-decoration:none;}
					.email-btn:hover{ background:url(' . $path . '/images/email-btn-bg-h.jpg) repeat-x; padding:4px 10px; border:none; cursor:pointer; font:normal 17px Arial, Helvetica, sans-serif; color:#fff; text-decoration:none;}
				  -->
				 </style>
				</head>
				<body>
				<div id="email-main" style="width:622px; margin:0 auto; min-height:200px; height:auto !important; height:200px; border:2px #8f8c8c solid;">
				 <div id="header" style="background:#8f8c8c; padding:7px 0px; padding-left:10px;">
				  <div class="email-logo" style="width:229px; height:27px;"><img src="'.$path . '/images/email-logo.jpg" width="229" height="27" border="0"/></div>
				  <div class="clr" style="clear:both;"></div>
				 </div>
				<div class="clr" style="clear:both;"></div>
				<div id="content" style="margin:0px; padding:10px;">';
    $newmessage .= $message;
    $newmessage .='<div class="clr"></div><div align="left">
              Visit our website <a title="Heardmentality.org" href="'.$base_url.'" target="_blank">Heardmentality.com</a> <br />
              <br />Thanks, <br />Heardmentality Team. </div>
							 <div align="center"><a href="' . $base_url . '"><input name="" type="button" value="View All Updates" class="email-btn"/></a></div>
							 <div class="clr"  style="clear:both;"></div>
							 </div>
							</div>
							</body>
						   </html>';
   // echo $newmessage;
   

    return mail($to, $subject, $newmessage, $headers);
}

function arrayToObject($array) {
	if(!is_array($array)) {
		return $array;
	}

	$object = new stdClass();
	if (is_array($array) && count($array) > 0) {
	  foreach ($array as $name=>$value) {
	     $name = strtolower(trim($name));
	     if (!empty($name)) {
	        $object->$name = arrayToObject($value);
	     }
	  }
      return $object;
	}
    else {
      return FALSE;
    }
}

function hm_mails($qid='', $nid='', $type='') {
    global $gSitePath, $user, $gDocPath, $base_root;

    $qdetails = node_load($qid);
      
    $mail_row = db_query("select mail from users where uid='" . $user->uid . "'");
    $fet_mail = db_fetch_object($mail_row);

    //$sel_follow = "select f.*,u.mail,u.notify_etype,u.name from follower as f join users as u on f.uid=u.uid where f.follower_id='" . $user->uid . "' and follower_id!=0 and cat_id=0 and question_id=0";
    $follower=_activity_heartbeat_related_uid_info($user->uid);
  
    $get_follow = db_query($sel_follow);
    $from = variable_get('site_mail');


    switch ($type) {
        case 'vote_answer':
            foreach($follower as $fuser){
                      $fet_follow=(object)load_user($fuser);
                      
                    $sel_user_cmt = "SELECT * FROM notification_mail_format Where id='5'";
                    $rs_mgmt = db_query($sel_user_cmt);
                    $list_content = db_fetch_object($rs_mgmt);
                    $subject_proj = $list_content->subject;
                    $contentm = str_replace("#uname#", $fet_follow->name, $list_content->content);
                    $contentm = str_replace("#anothername#", $user->name, $contentm);
                        $path=drupal_get_path_alias('node/'.$qid);
                    $contentm = str_replace("#question#", rtrim($qdetails->title, '?') . '?', $contentm);
                    $contentm = str_replace("#link#", $gSitePath . $path, $contentm);
                    $contentm = str_replace("#content#", ' has voted for the below issue. Kindly have a review', $contentm);

                    $ins_qry = "insert into hm_mails(from_mail_id,user_from_id,user_to_id,subject,content,mail_status,posted_date)values('$from','$from','" . $fet_follow->mail . "','" . $subject_proj . "','" . $contentm . "',0,now())";
                    db_query($ins_qry);
                
            }
            break;
        case 'add_question':

            foreach($follower as $fuser){
                      $fet_follow=(object)load_user($fuser);
                   //id=4 for add question
                    $sel_user_cmt = "SELECT * FROM notification_mail_format Where id='4'";
                    $rs_mgmt = db_query($sel_user_cmt);
                    $list_content = db_fetch_object($rs_mgmt);
                    $subject_proj = $list_content->subject;
                    $contentm = str_replace("#uname#", $fet_follow->name, $list_content->content);
                    $contentm = str_replace("#anothername#", $user->name, $contentm);

                      $path=drupal_get_path_alias('node/'.$qid);
                    $contentm = str_replace("#question#", rtrim($qdetails->title, '?') . '?', $contentm);
                    $contentm = str_replace("#link#", $gSitePath . $path, $contentm);
                    $contentm = str_replace("#content#", 'post a new Issue', $contentm);


                    $ins_qry = "insert into hm_mails(from_mail_id,user_from_id,user_to_id,subject,content,mail_status,posted_date)values('$from','$from','" . $fet_follow->mail . "','" . $subject_proj . "','" . $contentm . "',0,now())";
                    db_query($ins_qry);
           
            }
           
            break;
        case 'add_like':

            $sel_forum = "select * from forum_wavelets where wlid='" . $nid . "'";
            $forum_fet = db_query($sel_forum);
            $forum_row = db_fetch_object($forum_fet);
            $wavelet = $forum_row->wavelet;

            while ($fet_follow = db_fetch_object($get_follow)) {
                if ($fet_follow->notify_etype == 1) {
                    //id=4 for add question
                    $sel_user_cmt = "SELECT * FROM notification_mail_format Where id='5'";
                    $rs_mgmt = db_query($sel_user_cmt);
                    $list_content = db_fetch_object($rs_mgmt);
                    $subject_proj = $list_content->subject;
                    $contentm = str_replace("#uname#", $fet_follow->name, $list_content->content);
                    $contentm = str_replace("#anothername#", $user->name, $contentm);

                    $contentm = str_replace("#question#", $wavelet, $contentm);
                    //$contentm = str_replace("#link#", $wavelet, $contentm);
                    $contentm = str_replace("#content#", 'like new forum', $contentm);


                    $ins_qry = "insert into hm_mails(from_mail_id,user_from_id,user_to_id,subject,content,mail_status,posted_date)values('$from','$from','" . $fet_follow->mail . "','" . $subject_proj . "','" . $contentm . "',0,now())";
                    db_query($ins_qry);
                }
            }
            break;
        case 'add_forum':

            //$sel_wave = db_fetch_object(db_query("select * from {forum_wave} where fid='$nid'"));
            $sel_wave = db_fetch_object(db_query("select n.title from {content_type_forum} c join {node} n ON c.nid = n.nid where c.nid='$nid'"));
            $qpath=drupal_get_path_alias('node/'.$qid);
            
            while ($fet_follow = db_fetch_object($get_follow)) {
                if ($fet_follow->notify_etype == 1) {
                    //id=4 for add question
                    $sel_user_cmt = "SELECT * FROM notification_mail_format Where id='5'";
                    $rs_mgmt = db_query($sel_user_cmt);
                    $list_content = db_fetch_object($rs_mgmt);
                    $subject_proj = $list_content->subject;
                    $contentm = str_replace("#uname#", $fet_follow->name, $list_content->content);
                    $contentm = str_replace("#anothername#", $user->name, $contentm);

                    $contentm = str_replace("#question#", $wavelet, $contentm);
                    $contentm = str_replace("#link#", $gSitePath . $qpath, $contentm);
                    $contentm = str_replace("#content#", "created a Forum Topic [" . $sel_wave->title . "] for the below question. Kindly have a review", $contentm);


                    $ins_qry = "insert into hm_mails(from_mail_id,user_from_id,user_to_id,subject,content,mail_status,posted_date)values('$from','$from','" . $fet_follow->mail . "','" . $subject_proj . "','" . $contentm . "',0,now())";
                    db_query($ins_qry);
                }
            }
            break;
        case 'reply_forum':

            //$sel_wave = db_fetch_object(db_query("select * from {forum_wave} where fid='$nid'"));
            $sel_wave = db_fetch_object(db_query("select n.title, c.field_ref_qid_nid from {content_type_forum} c join {node} n ON c.nid = n.nid where c.nid='$nid'"));
            
            //$qdetails = load_question($sel_wave->qid_rid);
            $qdetails = node_load($sel_wave->field_ref_qid_nid);
            $qpath=drupal_get_path_alias('node/'.$sel_wave->field_ref_qid_nid);
            
            $sel_wavelet = db_fetch_object(db_query("select * from {forum_wavelets} where wlid='$nid' AND uid='$user->uid'"));
            $mail_row = db_query("select mail from users where uid='" . $user->uid . "'");
            $fet_mail = db_fetch_object($mail_row);

            $sel_follow = "select f.*,u.mail,u.notify_etype,u.name from follower as f join users as u on f.uid=u.uid where f.follower_id='" . $user->uid . "' and follower_id!=0 and cat_id=0 and question_id=0";

            $get_follow = db_query($sel_follow);
            while ($fet_follow = db_fetch_object($get_follow)) {
                if ($fet_follow->notify_etype == 1) {
                    //id=4 for add question
                    $sel_user_cmt = "SELECT * FROM notification_mail_format Where id='5'";
                    $rs_mgmt = db_query($sel_user_cmt);
                    $list_content = db_fetch_object($rs_mgmt);
                    $subject_proj = $list_content->subject;
                    $contentm = str_replace("#uname#", $fet_follow->name, $list_content->content);
                    $contentm = str_replace("#anothername#", $user->name, $contentm);

                    $contentm = str_replace("#question#", $wavelet, $contentm);
                    $contentm = str_replace("#link#", $gSitePath . $qpath, $contentm);
                    $contentm = str_replace("#content#", "posted a reply[" . $sel_wavelet->wavelet . "] under Forum Topic [" . $sel_wave->title . "] for the below question. Kindly have a review", $contentm);


                    $ins_qry = "insert into hm_mails(from_mail_id,user_from_id,user_to_id,subject,content,mail_status,posted_date)values('$from','$from','" . $fet_follow->mail . "','" . $subject_proj . "','" . $contentm . "',0,now())";
                    db_query($ins_qry);
                }
            }
            break;


        case 'user_badges':
            $sel_wave = db_fetch_object(db_query("select * from {user_badges} where badge='$nid' AND uid='$user->uid'"));
            //$sel_wavelet = db_fetch_object(db_query("select * from {forum_wavelets} where wlid='$nid' AND uid='$user->uid'"));
            $mail_row = db_query("select mail from users where uid='" . $user->uid . "'");
            $fet_mail = db_fetch_object($mail_row);

            $sel_follow = "select f.*,u.mail,u.notify_etype,u.name from follower as f join users as u on f.uid=u.uid where f.follower_id='" . $user->uid . "' and follower_id!=0 and cat_id=0 and question_id=0";

            $get_follow = db_query($sel_follow);
            while ($fet_follow = db_fetch_object($get_follow)) {

                $sel_user_cmt = "SELECT * FROM notification_mail_format Where id='5'";
                $rs_mgmt = db_query($sel_user_cmt);
                $list_content = db_fetch_object($rs_mgmt);
                $subject_proj = $list_content->subject;
                $contentm = str_replace("#uname#", $fet_follow->name, $list_content->content);
                $contentm = str_replace("#anothername#", $user->name, $contentm);
                $contentm = str_replace("#content#", "earn " . $sel_wave->bid . " badges ", $contentm);
                $ins_qry = "insert into hm_mails(from_mail_id,user_from_id,user_to_id,subject,content,mail_status,notify,posted_date)values('$from','$from','" . $user_namelistfs[0]['mail'] . "','" . $subject_proj . "','" . $contentm . "',0,0,now())";

                db_query($ins_qry);
            }
            break;

        case 'follower':
            $sel_ulists = "SELECT * FROM users LEFT JOIN user_profile ON users.uid=user_profile.uid Where users.uid='" . $nid . "'";

            $user_namelistfs = ExecuteQuery($sel_ulists, "select");
            $sel_user_cmt = "SELECT * FROM notification_mail_format Where id='1'";
            $rs_mgmt = db_query($sel_user_cmt);
            $list_content = db_fetch_object($rs_mgmt);
            $subject_proj = $list_content->subject;
            $contentm = str_replace("#uname#", $user_namelistfs[0]['name'], $list_content->content);
            $contentm = str_replace("#anothername#", $user->name, $contentm);
            //echo $contentm;die;
            $ins_qry = "insert into hm_mails(from_mail_id,user_from_id,user_to_id,subject,content,mail_status,notify,posted_date)values('$from','$from','" . $user_namelistfs[0]['mail'] . "','" . $subject_proj . "','" . $contentm . "',0,0,now())";
            db_query($ins_qry);

            //$mail_success = htmlmail_function($user_namelistfs[0]['mail'], $subject, $contentm, '');
            break;
        case 'notify_summary':

            $summarPeriod = db_result(db_query("SELECT notify_etype FROM {users} WHERE uid = '%d'", $user->uid));
            if($summarPeriod != 0){
                $periodType = $summarPeriod==1?'WEEK':'MONTH';
                $periodVal = $summarPeriod==1?'weekly':'monthly';
                $subject = $summarPeriod==1?'Heardmentality: Weekly Update':'Heardmentality: Monthly Update';
                
                $chkStatus = db_result(db_query("SELECT COUNT(*) FROM {hm_mails} WHERE mail_type = 3 AND user_to_id = '%s' AND posted_date > DATE_SUB(CURDATE(), INTERVAL 1 ".$periodType.")", $user->mail));
                if($chkStatus == 0){
                    $sql = "SELECT * FROM {notify_activity} WHERE uid = '%d' AND timestamp > DATE_SUB(CURDATE(), INTERVAL 1 ".$periodType.")";
                    $query = db_query($sql, $user->uid);
                    $output .=  t('<p style="font:bold 13px Arial, Helvetica, sans-serif; color:#666666; padding:5px 0px;">Hi '.$user->name.'</p><br /> Here are the your '.$periodVal.' activities <br />');
                    while($res = db_fetch_object($query)){
                        $output .= notiflymailContent($res);
                    }
                    //$ins_qry = "insert into hm_mails(from_mail_id,user_from_id,user_to_id,subject,content,mail_status,notify,posted_date, mail_type)values('$from','$from','jnavane@gmail.com','".$subject."','" . addslashes($output) . "',0,0,now(), 3)";
                    //db_query($ins_qry);
                     $headers = 'MIME-Version: 1.0' . "\r\n";
    $headers .= 'Content-type: text/html; charset=iso-8859-1' . "\r\n";
    $headers .= 'From: ' . $conf['site_name'] . ' <' . $conf['site_mail'] . '>' . "\r\n";
                    if(mail('jnavane@gmail.com', $subject, $output, $headers)){
                        drupal_set_message('Mail Sent', 'success');
                    }else{
                        drupal_set_message('Mail Failed', 'success');
                    }
                    
                }
            }
            break;
    }
}

function invite_cron() {
    global $gSitePath, $user, $gDocPath, $base_root;
    $send_qry = "select * from {hm_mails} where mail_status='0'";
    $send_exec = ExecuteQuery($send_qry, "select");

    foreach ($send_exec as $sendeach) {

        $mail_success = htmlmail_function($sendeach['user_to_id'], $sendeach['subject'], $sendeach['content'], '');
        if ($mail_success) {
            db_query("update hm_mails set mail_status=1 where mail_id='" . $sendeach['mail_id'] . "'");
        }
    }
}

// notify summary

function notiflymailContent($activities){
    global $base_path;

    $data = unserialize($activities->variables);
    switch ($activities->message_id) {
        CASE 'user_follow':
            $uid_target_details = user_load($data['target_id']);
            $mail .= '
                                    <h2 style="font:bold 13px Arial, Helvetica, sans-serif; color:#000; padding-bottom:10px; text-decoration:none;">You are following
                                            <a style="{ font:bold 13px Arial, Helvetica, sans-serif; color:#000; padding-bottom:10px; text-decoration:underline;}:hover{text-decoration:none}"    href="' . $base_url . '/profile/' . $uid_target_details->name . '">';
           // $mail .= UserPicture_small($data['target_id']);
            $mail .= '	</a>
                                    </h2>
                                    <b style="font:normal 11px Arial, Helvetica, sans-serif; color:#666666;">' . hmnews_ago($activities->timestamp) . '.</b>
                            ';
            break;

        CASE 'add_question':
            $mail .= '<p style="font:bold 13px Arial, Helvetica, sans-serif; color:#666666; padding:5px 0px;">' . t('Added new issue') . '&nbsp;' . l($data['q_title'], drupal_get_path_alias('node/' . $data['qid'])) . '</p><b>' . hmnews_ago($activities->timestamp) . '.</b>';
        CASE 'add_vote':
            $mail .= '<p style="font:bold 13px Arial, Helvetica, sans-serif; color:#666666; padding:5px 0px;">' . t('Voted on') . '&nbsp;' . l($data['q_title'], drupal_get_path_alias('node/' . $data['qid'])) . '</p><b>' . hmnews_ago($activities->timestamp) . '.</b>';
            break;
        CASE 'add_debate':
            $mail .= '<p style="font:bold 13px Arial, Helvetica, sans-serif; color:#666666; padding:5px 0px;">' . t('Added a argument on') . '&nbsp;' . $data['d_title'] . 'for the issue <br/>' . l($data['q_title'], drupal_get_path_alias('node/' . $data['qid'])) . '</p><b>' . hmnews_ago($activities->timestamp) . '.</b>';
            break;
        CASE 'add_resource':
            $mail .= '<p style="font:bold 13px Arial, Helvetica, sans-serif; color:#666666; padding:5px 0px;">' . t('Added a reference on') . '&nbsp;' . $data['r_title'] . 'for the issue <br/>' . l($data['q_title'], drupal_get_path_alias('node/' . $data['qid'])) . '</p><b>' . hmnews_ago($activities->timestamp) . '.</b>';
            break;
        CASE 'deb_agree':
            $mail .= '<p style="font:bold 13px Arial, Helvetica, sans-serif; color:#666666; padding:5px 0px;">' . t('Strengthened a argument on') . '&nbsp;' . $data['d_title'] . 'for the issue <br/>' . l($data['q_title'], drupal_get_path_alias('node/' . $data['qid'])) . '</p><b>' . hmnews_ago($activities->timestamp) . '.</b>';
            break;
        CASE 'deb_disagree':
            $mail .= '<p style="font:bold 13px Arial, Helvetica, sans-serif; color:#666666; padding:5px 0px;">' . t('Weakened a argument on') . '&nbsp;' . $data['d_title'] . 'for the issue <br/>' . l($data['q_title'], drupal_get_path_alias('node/' . $data['qid'])) . '</p><b>' . hmnews_ago($activities->timestamp) . '.</b>';
            break;
        CASE 'res_agree':
            $mail .= '<p style="font:bold 13px Arial, Helvetica, sans-serif; color:#666666; padding:5px 0px;">' . t('Strengthened a argument on') . '&nbsp;' . $data['r_title'] . 'for the issue <br/>' . l($data['q_title'], drupal_get_path_alias('node/' . $data['qid'])) . '</p><b>' . hmnews_ago($activities->timestamp) . '.</b>';
            break;
        CASE 'res_disagree':
            $mail .= '<p style="font:bold 13px Arial, Helvetica, sans-serif; color:#666666; padding:5px 0px;">' . t('Weakened a argument on') . '&nbsp;' . $data['r_title'] . 'for the issue <br/>' . l($data['q_title'], drupal_get_path_alias('node/' . $data['qid'])) . '</p><b>' . hmnews_ago($activities->timestamp) . '.</b>';
            break;
        CASE 'add_badege':
            $mail .= '<p style="font:bold 13px Arial, Helvetica, sans-serif; color:#666666; padding:5px 0px;">' . t('Got a new badge') . '&nbsp;' . $data['badge'] ;
            break;
        CASE 'question_flag':
            $mail .= '<p style="font:bold 13px Arial, Helvetica, sans-serif; color:#666666; padding:5px 0px;">' . t('Falgged the issue') . '&nbsp;' . '<br/>' . l($data['q_title'], drupal_get_path_alias('node/' . $data['qid'])) . '</p><b>' . hmnews_ago($activities->timestamp) . '.</b>';
            break;
        CASE 'update_profile':
            $mail .= '<p style="font:bold 13px Arial, Helvetica, sans-serif; color:#666666; padding:5px 0px;">' . t('Updated your profile') ;
            break;
    }

    return $mail;
}