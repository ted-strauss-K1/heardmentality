<?php
/**
 * Implementation of hook_perm().
 */
function user_search_perm() {
    return array('Search User', 'Following', 'Follower', 'Suggested Users', 'User Information', 'Question Information');
}

/**
 * Implementation of hook_menu().
 */
function user_search_menu() {

    $search_result['searchuser'] = array(
        'title' => '  SEARCH RESULTS',
        'page callback' => 'search_results',
        'access arguments' => array('Search User'),
        'type' => MENU_SUGGESTED_ITEM,
        'file' => 'user_search.pages.inc',
    );
     $search_result['searchuser_ajax'] = array(
        'title' => '  SEARCH RESULTS',
        'page callback' => 'search_user_ajax',
        'access arguments' => array('Search User'),
        'type' => MENU_SUGGESTED_ITEM,
        'file' => 'user_search.pages.inc',
    );
	
    $search_result['searchquestion'] = array(
        'title' => '  SEARCH RESULTS',
        'page callback' => 'search_results_question',
        'access arguments' => array('Search User'),
        'type' => MENU_SUGGESTED_ITEM,
        'file' => 'user_search.pages.inc',
    );
     $search_result['searchquestion_ajax'] = array(
        'title' => '  SEARCH RESULTS',
        'page callback' => 'search_results_ajax',
        'access arguments' => array('Search User'),
        'type' => MENU_SUGGESTED_ITEM,
        'file' => 'user_search.pages.inc',
    );
     $search_result['searchquestion_category_ajax'] = array(
        'title' => '  SEARCH RESULTS',
        'page callback' => 'category_ajax',
        'access arguments' => array('Search User'),
        'type' => MENU_SUGGESTED_ITEM,
        'file' => 'user_search.pages.inc',
    );
	 
//	$search_result['searchquestion/Follow'] = array(
//        'title' => '  SEARCH RESULTS',
//        'page callback' => 'search_follow',
//        'access arguments' => array('Search User'),
//        'type' => MENU_SUGGESTED_ITEM,
//        'file' => 'user_search.pages.inc',
//    );
//
//        $search_result['searchquestion/UnFollow'] = array(
//        'title' => '  SEARCH RESULTS',
//        'page callback' => 'search_unfollow',
//        'access arguments' => array('Search User'),
//        'type' => MENU_SUGGESTED_ITEM,
//        'file' => 'user_search.pages.inc',
//    );



        $search_result['categoryquestion/Follow'] = array(
        'title' => '  SEARCH RESULTS',
        'page callback' => 'question_follow',
        'access arguments' => array('Search User'),
        'type' => MENU_SUGGESTED_ITEM,
        'file' => 'user_search.pages.inc',
    );

        $search_result['categoryquestion/UnFollow'] = array(
        'title' => '  SEARCH RESULTS',
        'page callback' => 'question_unfollow',
        'access arguments' => array('Search User'),
        'type' => MENU_SUGGESTED_ITEM,
        'file' => 'user_search.pages.inc',
    );
	
    $search_result['follower'] = array(
        'title' => 'Follower',
        'page callback' => 'user_follower',
        'access arguments' => array('Follower'),
        'type' => MENU_SUGGESTED_ITEM,
        'file' => 'user_search.pages.inc',
    );

    $search_result['following'] = array(
        'title' => ' Following',
        'page callback' => 'user_following',
        'access arguments' => array('Following'),
        'type' => MENU_SUGGESTED_ITEM,
        'file' => 'user_search.pages.inc',
    );
    $search_result['suggest/follow'] = array(
        'title' => ' Suggested Users',
        'page callback' => 'suggest_follow',
        'access arguments' => array('Suggested Users'),
        'type' => MENU_SUGGESTED_ITEM,
        'file' => 'user_search.pages.inc',
    );
    $search_result['savefollowing'] = array(
        'title' => ' Following',
        'page callback' => 'save_follow',
        'access arguments' => array('Following'),
        'type' => MENU_SUGGESTED_ITEM,
        'file' => 'user_search.pages.inc',
    );


    $search_result['savefollower'] = array(
        'title' => ' Following',
        'page callback' => 'save_follower',
        'access arguments' => array('Following'),
        'type' => MENU_SUGGESTED_ITEM,
        'file' => 'user_search.pages.inc',
    );

    $search_result['userinfo'] = array(
        'title' => ' User Information',
        'page callback' => 'get_user_details',
        'access arguments' => array('User Information'),
        'type' => MENU_SUGGESTED_ITEM,
        'file' => 'user_search.pages.inc',
    );
    $search_result['questinfo'] = array(
        'title' => ' User Information',
        'page callback' => 'get_question_details',
        'access arguments' => array('Question Information'),
        'type' => MENU_SUGGESTED_ITEM,
        'file' => 'user_search.pages.inc',
    );
    $search_result['userresults'] = array(
        'title' => ' SEARCH RESULTS',
        'page callback' => 'search_results_user',
        'access arguments' => array('User Information'),
        'type' => MENU_SUGGESTED_ITEM,
        'file' => 'user_search.pages.inc',
    );

    $search_result['searchreport'] = array(
        'title' => 'SEARCH RESULTS',
        'page callback' => 'search_report',
        'type' => MENU_CALLBACK,
        'access arguments' => array('Notify Report'),
        'file' => 'user_search.pages.inc',
    );
    $search_result['searchcontent'] = array(
        'title' => 'SEARCH RESULTS',
        'page callback' => 'search_content',
        'type' => MENU_CALLBACK,
        'access arguments' => array('Notify Report Content'),
        'file' => 'user_search.pages.inc',
    );

    return $search_result;
}

function facetad_refine() {
    //print_r($_REQUEST);
    //query builder
    global $gSitePath, $user, $gDocPath, $base_root, $base_path;
    $start = '';
    $txt_search = '';
    $scid = '';
    $sscid = '';
    $suid = '';
    $lkr = '';
    $tag = '';
    $name = '';
    $fetresult = '';
    $idb = substr($_GET['q'], strrpos($_GET['q'], "/") + 1);
    //echo $idb;
    $page_name = "searchquestion";
    if (isset($_GET['start'])) {
        $start = $_GET['start'];
    }

    if (strlen($start) > 0 and !is_numeric($start)) {
        echo "Data Error";
        exit;
    }


    $eu = ($start - 0);
    $limit = 5; // No of records to be shown per page.
    $this1 = $eu + $limit;
    $back = $eu - $limit;
    $next = $eu + $limit;


    if (isset($_REQUEST['txt_search'])) {
        $name = $_REQUEST['txt_search'];
    }
   if($_REQUEST['q_country']!='')
     {
         $q_country = $_REQUEST['q_country'];
     }
     if($_REQUEST['q_state']!='')
     {
         $q_state = $_REQUEST['q_state'];
     }

     if($_REQUEST['q_city']!='')
     {
         $q_city = $_REQUEST['q_city'];
     }
    extract($_REQUEST);
    if (isset($_GET['scid'])) {
        $suid = $_GET['scid'];
    }
    //$suid=$_REQUEST['scid'];
    //echo "select * from category  where cat_id='".$suid."' " ;
    $sel_catm = db_query("select * from category  where cat_id='" . $suid . "'");
    $saveresult = db_fetch_object($sel_catm);
    $qry = '';
    if (isset($_GET['cid'])) {
        $cid = $_GET['cid'];
    }
    if (isset($_GET['scid'])) {
        $scid = $_GET['scid'];
    }
    if ($name) {
        $qry .= " question LIKE '%" . $name . "%' AND ";
    }


    
     
    if (!empty($sscid))
        $qry .= "qc.sscat=" . $sscid . "  AND ";
    if (!empty($scid))
        $qry .= "qc.scat=" . $scid . " AND ";
    if (!empty($cid))
        $qry .= "qc.cat=" . $cid . " AND ";
        if (!empty($q_country))
        $qry .= "q.country='" . $q_country . "' AND ";
         if (!empty($q_state))
        $qry .= "q.state='" . $q_state . "' AND ";
        if (!empty($q_city))
        $qry .= "q.city='" . $q_city . "' AND ";

    

    if ($tag != '') {
        $sel = "SELECT * FROM question as q, qtag as tg    WHERE tg.tag_id=$tag and tg.qid=q.qid   and q.status='1'  ";
    } else {
        //$sel = "SELECT * FROM question as q left join {question_cat} as qc on qc.qid=q.qid WHERE $qry status='1' group by q.qid ";
        ///chnaged vijay
      $sel = "SELECT q.*,qc.cat,qc.scat,qc.sscat FROM question as q left join {question_cat} as qc on qc.qid=q.qid WHERE $qry status='1' group by q.qid desc ";
      
    }


    $user_qry = db_query($sel);
    if ($tag != '') {
        $sel_count = mysql_num_rows(db_query("SELECT * FROM question as q, qtag as tg    WHERE tg.tag_id=$tag and tg.qid=q.qid  and q.status='1'   "));
    } else {
        $sel_count = mysql_num_rows(db_query($sel));
    }

    $ret['query'] = $sel;
    $ret['qcnt'] = $sel_count;
    $ret['txt_search'] = $_REQUEST['txt_search'];

    return $ret;
}

function refine_search()
{
$options = array('sortby' => 'countryname', 'sortorder' => 'ASC');
    $result .= geonames_query('countryinfo',NULL,$options);
   $result  .=  '  <div class="padding10 minheight" >';
$optionlist .=' <option value="0" >--Country--</option>';
    foreach ($result->results as $country) {
        $optionlist .= sprintf('<option value="%s">%s</option>', $country['countrycode'], $country['countryname']);
    }

    $result .= '<select name="q_country" style="width: 125px;" tabindex="16"  onchange="get_state(this.value);" id="q_country">'.$optionlist.'</select>';
//echo $optionlist;

    $result .= '<div id="chg_state"><select id="q_state" name="q_state" onchange="get_citys(this.value);" style="width: 125px;" tabindex="18"><option value="0" >--State--</option></select></div>';

    $result .= '<div id="chg_city"><select name="q_city" id="q_city" style="width: 125px;" tabindex="19"> <option value="0" >--Cities--</option></select></div>';

    $result .= '</div>';

    return $result;

}

