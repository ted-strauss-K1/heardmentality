<?php

/**
 * @return array
 */
function zip_menu () {
  $menu = array();

  $menu['admin/settings/zip'] = array(
    'title'            => t('Zip customs'),
    'page callback'    => 'drupal_get_form',
    'page arguments'   => array('zip_form'),
    'access arguments' => array('administer site configuration'),
    'type'             => MENU_NORMAL_ITEM,
  );

  return $menu;
}

/**
 *
 */
function zip_form () {
  $form = array();

  $form["submit"] = array(
    '#type'  => 'submit',
    '#value' => 'Generate Zip Files',
  );

  return $form;
}


/**
 * @param $dir
 *
 * @return array
 */
function scanpath ($path) {
  static $i;
  $i++;
  if (is_dir($path)) {
    $result = array();

    foreach (scandir($path) as $value) {
      if ($value === '.' || $value === '..') {
        continue;
      }
      $result = array_merge($result, scanpath("$path/$value"));
    }

    return $result;
  }

  else {
    return array($path);
  }
}

/**
 * @param $path
 */
function zip_mtime ($path) {
  $mtime = 0;

  $list = scanpath ($path);

  foreach ($list as $file) {
    $mtime_file = filemtime($file);
    if ($mtime_file > $mtime) {
      $mtime = $mtime_file;
    }
  }

  return $mtime;
}

/**
 *
 */
function zip_form_submit () {
  set_time_limit(0);
  $path = __DIR__ . '/files';

  //
  if (!is_writable($path)) {
    drupal_set_message('Path <b>' . $path . '</b> is not writable.', 'warning');
    return;
  }

  // theme
  $theme = 'heardmentalitylight';
  $filepath = $_SERVER['DOCUMENT_ROOT'] . '/' . db_result(db_query("SELECT filename FROM system WHERE name = '%s' AND type = 'theme'", $theme));

  if (file_exists($filepath)) {
    $info = drupal_parse_info_file($filepath);
    $version = $info['version'];


    $path_theme_info = $filepath;
    $path_theme_directory = dirname($filepath);
    $path_zip_name = $theme . '-' . $version . '.zip';
    $path_zip_name_tmp = 'tmp_' . $path_zip_name;
    $path_zip = $path . '/' . $path_zip_name;
    $path_zip_tmp = $path . '/' . $path_zip_name_tmp;

    // create tmp file
    $command = "zip -r $path_zip_tmp $path_theme_directory";
    shell_exec($command);

    if (file_exists($path_zip_tmp)) {
      if (file_exists($path_zip)) {
        if (($mtime1 = filemtime($path_zip)) < ($mtime2 = zip_mtime($path_theme_directory))) {
          drupal_set_message("Theme's <b>$theme</b> version is not incremented.", 'warning');
        }
      }
      else {
        $command = "mv $path_zip_tmp $path_zip";
        shell_exec($command);
      }

      @unlink($path_zip_tmp);
    }
  }

  // modules
  

  //  exit;
}
