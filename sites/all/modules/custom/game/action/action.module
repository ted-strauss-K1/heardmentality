<?php

/**
 * Implements hook_menu()
 *
 * @return array
 */
function action_menu () {
  $menu = array();

  // callbacks to queue and de-queue actions
  $menu['action/queue'] = array(
    'page callback'   => 'action_queue',
    'page arguments'  => array(),
    'access callback' => true,
  );
  $menu['action/dequeue'] = array(
    'page callback'   => 'action_dequeue',
    'page arguments'  => array(),
    'access callback' => true,
  );

  return $menu;
}

/**
 * Function to queue action
 *
 * @param array $params
 */
function action_queue ($params = null) {
  if (is_null($params)) {
    $params = $_REQUEST;
    unset($params['q']);
  }
  db_query("INSERT INTO {action_queue} SET timestamp = '%d', params = '%s'", time(), serialize($params));
}

/**
 * Function to dequeue actions
 */
function action_dequeue () {
  // todo execute actions

  $query = "SELECT * FROM {action_queue}";
  $vars = array();

  $result = db_query($query, $vars);
  while ($item = db_fetch_array($result)) {
    var_dump($item);
    $params = unserialize($item['params']);
    module_invoke_all('invoke_action', $item['timestamp'], $params);
    db_query("DELETE FROM {action_queue} WHERE id = '%s'", $item['id']);
  }
}
