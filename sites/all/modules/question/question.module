<?php
/**
 * Implementation of hook_perm().
 */
function question_perm() {
  return array('Question user','Question add','Question save','Question ajax','Question edit','Question delete','Admin Panel','Users List','Question List','Edit Question','View Question');
}


/**
 * Implementation of hook_menu().
 */
 
function question_menu() {	

$items['question'] = array(
    'title' => ' My Question',
    'page callback' => 'my_question',
    'access arguments' => array('Question user'),
    'type' => MENU_SUGGESTED_ITEM,
    'file' => 'question.pages.inc',
  );
$items['question/add'] = array(
    'title' => ' Add Question',
    'page callback' => 'question_add',
    'access arguments' => array('Question add'),
    'type' => MENU_SUGGESTED_ITEM,
    'file' => 'question.pages.inc',
  );
$items['question/save'] = array(
    'title' => ' Save Question',
    'page callback' => 'question_save',
    'access arguments' => array('Question save'),
    'type' => MENU_SUGGESTED_ITEM,
    'file' => 'question.pages.inc',
  );
  $items['question/ajax'] = array(
    'title' => ' Ajax Function',
    'page callback' => 'question_ajax',
	 'access arguments' => array('Question ajax'),
     'type' => MENU_CALLBACK,
    'file' => 'question.pages.inc',
  );
 $items['question/edit'] = array(
    'title' => 'Edit Question',
    'page callback' => 'edit_question',
	 'access arguments' => array('Question edit'),
     'type' => MENU_SUGGESTED_ITEM,
    'file' => 'question.pages.inc',
  );
  $items['question/delete'] = array(
    'title' => 'Delete Category',
    'page callback' => 'drupal_get_form',
	'page arguments' => array('question_delete_confirm', 3),
    'access arguments' => array('Question delete'),
    'type' => MENU_CALLBACK,
    'file' => 'question.pages.inc',
  );
  $items['question/reply'] = array(
    'title' => ' Add Question',
    'page callback' => 'question_reply',
    'access arguments' => array('Question add'),
    'type' => MENU_SUGGESTED_ITEM,
    'file' => 'question.pages.inc',
  );
 
 
 $items['admin/questions'] = array(
    'title' => 'Admin Panel',
    'page callback' => 'admin_content',
	 'type' => MENU_CALLBACK,
	   'access arguments' => array('Admin Panel'),
       'file' => 'question.pages.inc',
  );
 
  $items['admin/panel'] = array(
    'title' => 'Admin Panel',
    'page callback' => 'admin_panel_tab',
	 'type' => MENU_CALLBACK,
	   'access arguments' => array('Admin Panel'),
       'file' => 'question.pages.inc',
  );
 
 
  $items['admin/panelc'] = array(
    'title' => 'Admin Panel',
    'page callback' => 'panel_content',
	 'type' => MENU_CALLBACK,
	   'access arguments' => array('Admin Panel'),
    'file' => 'question.pages.inc',
  );
 
 $items['admin/userlist'] = array(
    'title' => 'Users List',
    'page callback' => 'moderate_user',
    'access arguments' => array('Users List'),
    'type' => MENU_SUGGESTED_ITEM,
    'file' => 'question.pages.inc',
  );

  $items['admin/question/list'] = array(
    'title' => 'Question List',
    'page callback' => 'moderate_quest',
    'access arguments' => array('Question List'),
    'type' => MENU_SUGGESTED_ITEM,
    'file' => 'question.pages.inc',
  );
 $items['admin/notifymail'] = array(
    'title' => 'Moderate Question',
    'page callback' => 'moderate_user_mail',
    'access arguments' => array('Moderate User'),
    'type' => MENU_SUGGESTED_ITEM,
    'file' => 'question.pages.inc',
  );
 $items['admin/edit/questions'] = array(
    'title' => 'Edit Question',
    'page callback' => 'edit_questions',
    'access arguments' => array('Edit Question'),
    'type' => MENU_SUGGESTED_ITEM,
    'file' => 'question.pages.inc',
  );
  $items['admin/view/question'] = array(
    'title' => 'View Question',
    'page callback' => 'view_questions',
    'access arguments' => array('View Question'),
    'type' => MENU_SUGGESTED_ITEM,
    'file' => 'question.pages.inc',
  );
  
    $items['autosuggest'] = array(
    'title' => 'Add Question',
    'page callback' => 'auto_suggest_quest',
    'access arguments' => array('Question add'),
    'type' => MENU_SUGGESTED_ITEM,
    'file' => 'question.pages.inc',
  );
  
  
   $items['admin/dupe/questions'] = array(
    'title' => 'Dupe Question',
    'page callback' => 'dupe_question',
    'access arguments' => array('Dupe Question'),
    'type' => MENU_SUGGESTED_ITEM,
    'file' => 'question.pages.inc',
  );
  
  
  
  return $items;
}


// mysql query execution	
	function ExecuteQuery($Query, $Qrytype)
	{
		if(!empty($Query) && !empty($Qrytype))
		{
			switch(strtolower($Qrytype))
			{
				case "select":
					$Result = db_query($Query) ;
					if($Result)
					{	
						$ResultSet = array();
						while($ResultSet1 = mysql_fetch_array($Result))
							$ResultSet[] = $ResultSet1;
						return $ResultSet;
					}
					else return false;
					break;
				case "update":
					$Result = db_query($Query);
					if($Result)
					{
						$AffectedNums = mysql_affected_rows();
						return $AffectedNums;
					}
					else return false;
					break;
				case "norows":
					$Result = db_query($Query) ;
					if($Result)
					{
						$Totalrows = mysql_num_rows($Result);
						return $Totalrows;
					}
					else return false;
					break;	
					
				case "insert":
					$Result = db_query($Query) ;
					if($Result)
					{
						$LastInsertedRow = mysql_insert_id();
						return $LastInsertedRow;
					}
					else return false;
					break;
				case "delete":
					$Result = db_query($Query) ;
					if($Result)
						return true;
					else
						return false;
			}
		}
		
	}
//function to update profileabadge by post
 function updateProfileBadge($uid = null){
       global $gSitePath,$user,$gDocPath,$base_root;
	$badges=''; $gold='';$silver='';$bronze='';
	 $pat = $gSitePath.drupal_get_path('module', 'profile');
	$gp=guru_points('user',$uid);
	$badges.='<span title="reputation score '.$gp.'" class="reputation-score">'.$gp.'</span>';
	
	 $query="SELECT count(*) as cnt,btype FROM user_badges as ub left join badges as b on b.bid=ub.bid where ub.uid='$uid' group by b.btype ";
	$btype= ExecuteQuery($query, "select");
	
	if(count($btype)>0){
		
		foreach($btype as $list){
			
			switch($list['btype'])
			{
				case 'gold':
                                    $gold .= '<li><img src="'.$gSitePath.'sites/all/themes/newtheme/images/pr1.jpg" />'.$list['cnt'].'</li>';
					//$gold.='<span title="'.$list['cnt'].' gold badges"><span class="badge1 gold"></span><span class="badgecount">'.$list['cnt'].'</span></span>&nbsp;';
						break;
				case 'silver':
                                     $silver .= '<li><img src="'.$gSitePath.'sites/all/themes/newtheme/images/pr2.jpg" />'.$list['cnt'].'</li>';
					//$silver.='<span title="'.$list['cnt'].' silver badges"><span class="badge2 silver"></span><span class="badgecount">'.$list['cnt'].'</span></span>&nbsp;';
						break;		
				case 'bronze':
                                    $bronze .= '<li><img src="'.$gSitePath.'sites/all/themes/newtheme/images/pr3.jpg" />'.$list['cnt'].'</li>';
					//$bronze.='<span title="'.$list['cnt'].' bronze badges"><span class="badge3 bronze"></span><span class="badgecount">'.$list['cnt'].'</span></span>&nbsp;';
						break;
			}			
		}

	}
	
	$badges.=$gold.$silver.$bronze;
	
	
	return $badges;
	}
	
	
	setlocale(LC_ALL, 'en_US.UTF8');
function clean_url($str, $replace = array(), $delimiter = '-',$qid='') {
    if (! empty($replace)) {
        $str = str_replace((array) $replace, ' ', $str);
    }
    
    $clean = iconv('UTF-8', 'ASCII//TRANSLIT', $str);
    $clean = preg_replace("/[^a-zA-Z0-9\/_|+ -]/", '', $clean);
    $clean = strtolower(trim($clean, '-'));
    $clean = preg_replace("/[\/_|+ -]+/", $delimiter, $clean);
    if(!empty($qid)){
    $clean=$clean.'-'.$qid;
    }
    return $clean;
}
	
	function myTruncate($string, $limit, $break = " ", $pad = "") {
    
    // return with no change if string is shorter than $limit
    if (strlen($string) <= $limit)
        return $string;
    $string = substr($string, 0, $limit);
    if (false !== ($breakpoint = strrpos($string, $break))) {
        $string = substr($string, 0, $breakpoint);
    }
    $string = str_replace("\"", "", $string);
    return $string.$pad;
}
	
	
	function load_question($qid=''){
           
            if(!empty($qid)){

                   $query="SELECT * FROM question where qid='$qid' LIMIT 0,1";
		$result=ExecuteQuery($query, "select");
            }
            foreach($result as $final)
            {

            }
            return $final;
        }

      function load_votes($qid=''){

        $final=array();

        //no of votes
          $queryd = "SELECT qid, SUM(vote) as possiblevote FROM possible_answer where qid='" . $qid . "' GROUP BY qid";
            $query_listd = db_query($queryd);
            $fetvotd = db_fetch_object($query_listd);

            $query_sugests = "SELECT qid, SUM(vote) as suggestv FROM suggest_answer where qid='" . $qid . "' GROUP BY qid";
            $query_sugestlistd = db_query($query_sugests);
            $fetvotsugestbg = db_fetch_object($query_sugestlistd);
            $final['qns'] = $fetvotd->possiblevote + $fetvotsugestbg->suggestv;


        //no of resource n forum posts
         $final['resource'] = db_result(db_query("SELECT COUNT(*) FROM resource where  qid='$qid'"));

         //count forum post
         $forum_qry = "select count(*) as forum_count from forum_wave where qid_rid='".$qid."'";
         $forum_res = db_query($forum_qry);
         $forum_rows = db_fetch_object($forum_res);
         $final['forum'] = $forum_rows->forum_count;



    $query = " SELECT (SELECT count( * ) FROM forum_wavelets AS w WHERE w.wid = f.fid GROUP BY w.wid ) AS wcnt FROM forum_wave AS f WHERE f.qid_rid = '$qid' ";
   
    $list = ExecuteQuery($query, "select");
    $x = 0;
    foreach ($list as $fcnt) {

        $x = $x + $fcnt['wcnt'];
    }
         $final['post']=$x;

      return $final;
      }
      